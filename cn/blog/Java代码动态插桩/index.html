<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>Java代码动态插桩.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="Java代码动态插桩.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="Java代码动态插桩.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2017/03/23 20:26:54"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel vubbuv gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-1a3bc1a098c2d99b.js" defer=""></script><script src="/_next/static/chunks/771-6a778ea1fc3e748f.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-e6dc13f92e5951fe.js" defer=""></script><script src="/_next/static/6yQ4Eq8ioydqKhi_Yja0Q/_buildManifest.js" defer=""></script><script src="/_next/static/6yQ4Eq8ioydqKhi_Yja0Q/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:absolute;top:22px;right:15px;height:100px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-style-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">Java代码动态插桩.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2017/03/23 20:26:54</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: Java代码动态插桩
date: 2017/03/23 20:26:54
updated: 2017/05/19 12:24:43
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>代码插桩方案有n种，就不一一细说。说下常用的几种。</p>
<h2>1.利用动态代理InvocationHandler</h2>
<p>我动手写了个例子，这个类的目的是让方法执行之前，打印每个方法的方法名和参数，因为我老是遇到类似需求，需要我打印一个观察者的所有的方法的执行日志。</p>
<pre><code class="language-java">
/**
 * =======让类的每个方法都执行时打印日志========
 * demo:
 *
 *  SMObserver mSMObserver = new SMObserver();
 *  SMObserverInterface me=(SMObserverInterface)MethodDynamicLogger.generatorInterface(mSMObserver);
 *  me.something();
 );
 */
public class MethodDynamicLogger implements InvocationHandler {

    Object mObject;
    CoreLogger mCoreLogger;//使用CoreLogger 在release版本跳过 打印日志
    public MethodDynamicLogger(Object obj) {
        mObject = obj;
        String tag =&quot; &quot;+mObject.getClass().getSimpleName()+&quot;--&gt;&quot;;
        mCoreLogger=CoreLogger.getLogger(tag);
    }


    @Override
    public Object invoke(Object o, Method method, Object[] args) throws Throwable {
        StringBuilder builder=new StringBuilder(method.getName()+&quot;(&quot;);

        if(args!=null)
        {
            Iterator&lt;Object&gt; iterator= Arrays.asList(args).iterator();
            while (iterator.hasNext())
            {
                builder.append(iterator.next()+&quot;&quot;);
                if(iterator.hasNext()) {
                    builder.append(&quot; , &quot;);
                }
            }
        }
        builder.append(&quot;)&quot;);

        mCoreLogger.d(builder.toString());
        method.invoke(mObject, args);
        return null;
    }

    private Object generator()
    {
        return Proxy.newProxyInstance(
                mObject.getClass().getClassLoader(),
                mObject.getClass().getInterfaces(),
                this
        );
    }


    public static Object generatorInterface(Object obj)
    {
        return new MethodDynamicLogger(obj).generator();
    }
}

</code></pre>
<p>这里SMObserverInterface 是一个interface，SMObserver是一个类，SMObserver只要implement这个interface，我就可以实现代码插桩，就用这个代理去绑定了observer的每个方法，在每个方法执行之前打印方法名和参数。
这种方案比较适用于类的初始化由自己控制的，是自己给自己的代码插桩。</p>
<h2>2.编译时生成</h2>
<p>其实我的github上有个项目：<a href="https://github.com/BruceWind/GeneratorX">GeneratorX</a>,就是利用编译时生成，我是利用java的编译时生成。</p>
<p>这种方案其实在butterknife上也在使用。你只是简单写了一个注解，然后butterknife利用JAVA的AbstractProcessor类实现生成代码，把findview和setOnClick事件的代码帮你插入到代码里。</p>
<h2>3.修改字节码</h2>
<p>我写了个修改字节码的demo挂在github上。<a href="https://github.com/BruceWind/Jar_Hook">https://github.com/BruceWind/Jar_Hook</a></p>
<pre><code class="language-java">//jar包中的代码：
package com.androidyuan;

public class Hello {
    public Hello() {
    }

    public static void sayHello(String name) {//被hook的方法
    }
}
</code></pre>
<p>在sayHello方法里插入了<code>MainActivity.hookXM(String name);</code>.</p>
<pre><code class="language-java">public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        ...
        ...
        Hello.sayHello(&quot;hello&quot;);
    }

    public static void hookXM(String name) {//插入执行这行代码
        Log.i(&quot;hookXM&quot;, &quot;hello av8d,im &quot;+name+&quot;.&quot;);
    }
}
</code></pre>
<p><em>执行效果请run起来看日志。</em></p>
<h3>目前实现原理</h3>
<p>利用修改字节码技术，<a href="https://github.com/BryanSharp/hibeaver">hibeaver</a>是ASM基于gradle的一种包装方案，核心原理在于ASM框架。</p>
<p><del>《ASM从入门到放弃》</del>
<del>太长不看</del>
ASM是一个老牌字节码框架。当然了，字节码操作的框架这几年有很多，只不过目前ASM是很多项目都在使用的罢了，包括kotlin也在使用。</p>
<p>利用ASM框架hook一个jar包内的一个方法，实现代码插桩。
目前，仅仅在编译期间hook，没有在运行时hook.</p>
<h3>在运行期hook是否是一种可行性方案？</h3>
<blockquote>
<ul>
<li>Dalvik:
理论上来说运行时hook也可以，基于ASMDEX框架就好，Dalvik机器使用java字节码解释执行，运行期间也不断被自带JIT编译器修改着字节码。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>Art:
但是Art虚拟机之后，apk安装之后会把字节码转为跟其他C或C++同样方案的机器码，这样子以机器码加速执行的性能非常高。
DVM是不遵守JVM规范的虚拟机。
Art在不同的版本之间实现大大变化，最初只有AOP没有JIT，后来又加入了JIT。</li>
</ul>
</blockquote>
<p><strong>综上：</strong>
android平台还是老老实实的使用编译后期hook的方案吧。</p>
<h2>4.专门用于代码插桩的框架</h2>
<p>比较知名的有<a href="http://blog.csdn.net/yczz/article/details/14497897">BCEl</a>，<a href="http://jiapi.sourceforge.net/">JIAPI</a>。
我就不写demo了，毕竟那样太辛苦了( @_@ )，上面几种我已经写了demo了，本文的目的在于分享，不在于练代码啊！！！！<br/>
这种东西的变种就是IDE插件，帮你用插件实现代码插桩。</p>
<h1></h1>
<p>其实，回过头来看，java的开放，编译时生成，运行时可修改字节码，反射，使用隐藏API等等，这些东西都足以说明一个问题：代码安全性几乎是没有的，我想hack你，想让你死，我可以瞬间想到一百种致你于死地的方法，哈哈哈！！ 开玩笑。。。</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"Java代码动态插桩","title":"Java代码动态插桩.md","mdsource":"md/Java代码动态插桩.md","date":" 2017/03/23 20:26:54","category":"几年后回看会觉得写的太烂"},"content":"title: Java代码动态插桩\ndate: 2017/03/23 20:26:54\nupdated: 2017/05/19 12:24:43\ncategories:\n- 技术\n---\n代码插桩方案有n种，就不一一细说。说下常用的几种。\n\n## 1.利用动态代理InvocationHandler\n\n我动手写了个例子，这个类的目的是让方法执行之前，打印每个方法的方法名和参数，因为我老是遇到类似需求，需要我打印一个观察者的所有的方法的执行日志。\n\n``` java\n\n/**\n * =======让类的每个方法都执行时打印日志========\n * demo:\n *\n *  SMObserver mSMObserver = new SMObserver();\n *  SMObserverInterface me=(SMObserverInterface)MethodDynamicLogger.generatorInterface(mSMObserver);\n *  me.something();\n );\n */\npublic class MethodDynamicLogger implements InvocationHandler {\n\n    Object mObject;\n    CoreLogger mCoreLogger;//使用CoreLogger 在release版本跳过 打印日志\n    public MethodDynamicLogger(Object obj) {\n        mObject = obj;\n        String tag =\" \"+mObject.getClass().getSimpleName()+\"--\u003e\";\n        mCoreLogger=CoreLogger.getLogger(tag);\n    }\n\n\n    @Override\n    public Object invoke(Object o, Method method, Object[] args) throws Throwable {\n        StringBuilder builder=new StringBuilder(method.getName()+\"(\");\n\n        if(args!=null)\n        {\n            Iterator\u003cObject\u003e iterator= Arrays.asList(args).iterator();\n            while (iterator.hasNext())\n            {\n                builder.append(iterator.next()+\"\");\n                if(iterator.hasNext()) {\n                    builder.append(\" , \");\n                }\n            }\n        }\n        builder.append(\")\");\n\n        mCoreLogger.d(builder.toString());\n        method.invoke(mObject, args);\n        return null;\n    }\n\n    private Object generator()\n    {\n        return Proxy.newProxyInstance(\n                mObject.getClass().getClassLoader(),\n                mObject.getClass().getInterfaces(),\n                this\n        );\n    }\n\n\n    public static Object generatorInterface(Object obj)\n    {\n        return new MethodDynamicLogger(obj).generator();\n    }\n}\n\n```\n\n这里SMObserverInterface 是一个interface，SMObserver是一个类，SMObserver只要implement这个interface，我就可以实现代码插桩，就用这个代理去绑定了observer的每个方法，在每个方法执行之前打印方法名和参数。\n这种方案比较适用于类的初始化由自己控制的，是自己给自己的代码插桩。\n\n## 2.编译时生成\n\n其实我的github上有个项目：[GeneratorX](https://github.com/BruceWind/GeneratorX),就是利用编译时生成，我是利用java的编译时生成。\n\n这种方案其实在butterknife上也在使用。你只是简单写了一个注解，然后butterknife利用JAVA的AbstractProcessor类实现生成代码，把findview和setOnClick事件的代码帮你插入到代码里。\n\n\n## 3.修改字节码\n我写了个修改字节码的demo挂在github上。[https://github.com/BruceWind/Jar_Hook](https://github.com/BruceWind/Jar_Hook)\n\n\n``` java\n//jar包中的代码：\npackage com.androidyuan;\n\npublic class Hello {\n    public Hello() {\n    }\n\n    public static void sayHello(String name) {//被hook的方法\n    }\n}\n```\n\n在sayHello方法里插入了`MainActivity.hookXM(String name);`.\n```java\npublic class MainActivity extends AppCompatActivity {\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        ...\n        ...\n        Hello.sayHello(\"hello\");\n    }\n\n    public static void hookXM(String name) {//插入执行这行代码\n        Log.i(\"hookXM\", \"hello av8d,im \"+name+\".\");\n    }\n}\n```\n*执行效果请run起来看日志。*\n\n### 目前实现原理\n\n利用修改字节码技术，[hibeaver](https://github.com/BryanSharp/hibeaver)是ASM基于gradle的一种包装方案，核心原理在于ASM框架。\n\n~~《ASM从入门到放弃》~~ \n~~太长不看~~\nASM是一个老牌字节码框架。当然了，字节码操作的框架这几年有很多，只不过目前ASM是很多项目都在使用的罢了，包括kotlin也在使用。\n\n\n利用ASM框架hook一个jar包内的一个方法，实现代码插桩。\n目前，仅仅在编译期间hook，没有在运行时hook.\n\n### 在运行期hook是否是一种可行性方案？\n\n\u003e + Dalvik:\n    理论上来说运行时hook也可以，基于ASMDEX框架就好，Dalvik机器使用java字节码解释执行，运行期间也不断被自带JIT编译器修改着字节码。\n\n\u003e + Art:\n    但是Art虚拟机之后，apk安装之后会把字节码转为跟其他C或C++同样方案的机器码，这样子以机器码加速执行的性能非常高。\n    DVM是不遵守JVM规范的虚拟机。\n    Art在不同的版本之间实现大大变化，最初只有AOP没有JIT，后来又加入了JIT。\n\n**综上：**\n    android平台还是老老实实的使用编译后期hook的方案吧。\n\n## 4.专门用于代码插桩的框架\n比较知名的有[BCEl](http://blog.csdn.net/yczz/article/details/14497897)，[JIAPI](http://jiapi.sourceforge.net/)。\n我就不写demo了，毕竟那样太辛苦了( @_@ )，上面几种我已经写了demo了，本文的目的在于分享，不在于练代码啊！！！！  \n这种东西的变种就是IDE插件，帮你用插件实现代码插桩。\n\n# \n其实，回过头来看，java的开放，编译时生成，运行时可修改字节码，反射，使用隐藏API等等，这些东西都足以说明一个问题：代码安全性几乎是没有的，我想hack你，想让你死，我可以瞬间想到一百种致你于死地的方法，哈哈哈！！ 开玩笑。。。\n\n\n","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"Java代码动态插桩"},"buildId":"6yQ4Eq8ioydqKhi_Yja0Q","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>