<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>客户端安全加密的思考和实战.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="客户端安全加密的思考和实战.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="客户端安全加密的思考和实战.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2017/02/18 21:53:33"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel vubbuv gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-f7777f3ea9ebdd54.js" defer=""></script><script src="/_next/static/HT0wMZc9WfQm5UQ_5R-LL/_buildManifest.js" defer=""></script><script src="/_next/static/HT0wMZc9WfQm5UQ_5R-LL/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:absolute;top:22px;right:15px;height:100px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-style-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">客户端安全加密的思考和实战.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2017/02/18 21:53:33</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: 客户端安全加密的思考和实战
date: 2017/02/18 21:53:33
updated: 2017/02/19 16:58:41
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>本文是面向native安全设计。</p>
<blockquote>
<p>大家所知道的android程序员再代码安全方面做的大多数仅仅是把代码放到到so里面就可以了，那么实际上这样子安全吗？
实际上，我作为一个爱思考的android程序员，我连会hack玩的一些高端的东西都不会，也轻松破解你。</p>
</blockquote>
<h1></h1>
<p>在参与一个项目时，发现安全加密需要客户端做，但是作为一个有代码精神的程序员，我有几个问题需要慎重参与跟同事考虑几个重要的问题：
1.使用什么加密算法？
2.算法怎么保密？
3.key怎么做保密？
4.hack常见的破解我本地代码的手段是什么？</p>
<p>常见的大家都是去做对称加密， 来保证网络传输的数据安全性，算法大家一般都是AES，可能老的一些项目还在使用3DES算法，AES主要就是性能高所以目前大量放弃AES。</p>
<h1></h1>
<p>回到破解的方向考虑，我怎么防止被人破解：</p>
<h3>几种方案：</h3>
<p>1.key存到so中:</p>
<blockquote>
<p>作为一个开发者来说，你觉得key是加密的核心，你把key存到native中，然而，我反编译一下apk，从java代码里看到你的全部代码是AES算法，我觉得破解你的核心是key，我只要拿到你的key，看到你把key存到c中了，通过调用一个jni接口，就可以拿到你的key，这个时候我的破解方案就是，修改你的java代码，在代码里插入一行代码把jni取到的key打印到日志里，再二次打包运行即可。</p>
</blockquote>
<h1></h1>
<p>2.key和算法都存在so中：</p>
<blockquote>
<p>如果上面的破解者只是一个普通的android程序员，可能这个时候还是可以破解你的，他不再目的为了取到你的key，而是仅仅当作你的so只是一个加密算法而已，我不用去破解你的so，只需要知道怎么调用你即可，我编译一下你的apk，看下你的java代码，就看到你怎么调用了，我就可以在新项目里就可以调用。
这样子的话，我有个高级的方案，就是防止二次打包，问题在于，这个时候我怎么防止你二次打包，这个解决方案就是keystore的md5或者hashcode，就是在java调用so中的加密算法时，c的代码里要先去检查一下当前应用的包名应用的keystore的hashcode。这个校验一定要在c里面做，java太容易篡改，于是会有下面一个安全方案：</p>
</blockquote>
<h1></h1>
<p>3.key 和 算法同时在so中，并做防止二次打包的校验：</p>
<blockquote>
<p>这个时候，做为一个android程序员我已经很难破解了，我看不到你的key，最多，我只能在反编译apk dex文件时看到你的jni接口的命名，大概看出你是aes算法加密，只是我拿不到你的key。但是，目前我已经几乎看到两个点。这个时候，作为一个android程序可能很难破解你了。
普通android程序员大概只是知道你是一个aes算法，但是，我如果能拿到你的key，还是可以破解。
这个时候，我用IDA去反汇编so，发现竟然直接看到了你的key，这个时候怎么防止我去反汇编呢？
ndk有个配置是符号表，可以用符号表存一些字符串，把这些东西存到符号表中，然后再ndk编译时使用隐藏符号表的方案。
ok，是的这是个好方案。
在尝试之后发现反汇编之后确实无法看到key的字符串了。IDA和objdump两个软件都有尝试结果同样看不到字符串了。
第一张，图我代码里使用了 <code>uint8_t AES_KEY[] = &quot;1234567890abcdef&quot;;</code>
<img src="assets/key.png" alt=""/>
第二张图我反汇编之后，还可以看到这个字符串。
<img src="assets/section.png" alt=""/></p>
</blockquote>
<h1></h1>
<p>4.key 和 算法同时在so中，并做防止二次打包的校验,在隐藏符号表</p>
<blockquote>
<p>这个时候，IDA是不行了，然后作为一个linux用户，我想想别的方案，发现apt仓库里有个objdump，我用objdump反编译一下，直接就看到你key。
那么现在怎么办呢？有个方案，就是我的代码里存的key并不是一个真实的key，我把key做一些变换之后才能用，变换的代码我写在c里面，调用so里面的加密算法之前，我需要先调用c的init方法，生成好真实的key。</p>
</blockquote>
<h1></h1>
<p>5.非真实的key存在so中，再生成真实的key，同时给so，做防止二次打包的校验</p>
<blockquote>
<p>那么，我想办法还是可以破解你，我利用堆栈溢出从内存地址中取到你生成好的key。
这时候，从这个攻防的等级逐渐加深，你会发现，原来key是非常不安全，总能想办法破解你，拿到你的key。</p>
</blockquote>
<h1></h1>
<h2>加密的核心无非就是两点：</h2>
<blockquote>
<ul>
<li>1.加密算法</li>
<li>2.key
算法方面除非你用自定义加密算法，否则很难保证不被人猜到，就那么常见的几种加密方式，AES，DES杂七杂八。
那么，key的安全性设计就是更加的难了，只要你的key写在代码里，或者通过运行时生成的方式生成再内存中，我总是可以详尽办法拿到你的key。
这样子的话，算法和key都很好搞定。</li>
</ul>
</blockquote>
<h1>所以</h1>
<p>最好的安全设计方案是自定义加密啊算法，在AES上面大量的修改，或者在Base64上做大量修改，c的代码被打包成机器码之后不但很难看懂，而且几乎没法二次打包，另外就是本地客户端不存key，也不通过服务端下去发key。
几个常见的例子：
##《模仿游戏》
模仿游戏中德国采用的“英格码”无法破译，他的涉及思想就是网络传输中不发送key，同时没有一个固定的key，防止你去破解，就是动态key技术，导致你就算抓到他的秘文用超级计算机取暴力破解，破解出来也已经是当时的key了，你再去破解今天的数据的时候，key已经变了。
这个是到动态key的涉及思想。</p>
<h2>SSH的设计思想</h2>
<p>本机电脑上存储一个key，server端存储一个key，使用者一般通过key访问server，key涉及的特别的复杂，就算超级计算机破解也需要很长时间，如果用户发现自己的key被破解了，那么直接后台删除掉这个key重新生成一个key。这也是一种动态key设计思想，只不过他的变化规律无迹可循，而且用户可以再自己帐号被盗之后重置加密key。</p>
<h1></h1>
<p>这都是针对你的平台田地多，防止专业的破解团体来说的，而针对小的破解团体的话，你只要保证算法不被猜到，同时客户端不存key，而且不在网络传输的传递key即可提升破解难度。</p>
<pre><code>想起曾经参加安卓巴士搞得一个安全方面的座谈会，我靠，360和阿里聚安全的大佬在台上信誓旦旦的说只要你把所有的代码放到native去实现，安全就已经提升了很高的等级，但是后来自己尝试破解native才知道，他妈的都是狗屁，破解native也特么的很简单。
</code></pre>
<h1>反汇编可以看到很多东西</h1>
<p>1.方法名：就可以看到你的加密算法了，这个时候你可以用JniOnload去做映射，防止被看到方法名。
2.代码里写的string，所以key完全不能存到代码里。</p>
<h2>所以，为了防止被反汇编，有一些方案去帮助你</h2>
<p>利用使用O-LLVM在NDK打包so时进行混淆处理，增加那些专门做逆向编程的人的破解难度。
如果本地非要存字符串，请不要存真实的，而是需要经过转换的字符，先存一个非真实字符到字符表，再配置隐藏字符表，然后运行时不能把key生成到一个static字段中，这样子很容易利用堆栈溢出pop出你的值，所以就算做本地转换也请用短生命域的临时变量去做，用完即可丢弃，c的释放内存速度超级快，只要引用计数降低到0即可释放，也就是说这段加密算法走完，key就丢弃了。
例子代码：</p>
<pre><code>static char* base_key=&quot;HJDKHFDSJFDFHA324723894djksfh&quot;;

char* encode(Stirng str)
{
    return encode(str,getRealKey(base_key));
}

char* encode(char* str,char* key)
{
    char * strEncode;
    //todo something
    return strEncode;
}

char * getRealKey(char* base)
{
    char* realk=&quot;&quot;;

    //TODO something
    return realk;
}
</code></pre>
<p>这样子，你代码里并没有存真实的key，然后NDK打包又经过混淆，做逆向的人就很难从汇编中看出你的生成key 的算法了，想要利用堆栈溢出pop出你存在静态变量里的key也拿不到真实的key，而动态字段存在内存空间中的时间1毫秒都不到根本不能pop出。</p>
<h2>鸣谢</h2>
<blockquote>
<p><a href="https://www.linux.com/blog/4-ways-password-could-be-hacked-using-common-linux-tools">https://www.linux.com/blog/4-ways-password-could-be-hacked-using-common-linux-tools</a></p>
</blockquote></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8%E5%8A%A0%E5%AF%86%E7%9A%84%E6%80%9D%E8%80%83%E5%92%8C%E5%AE%9E%E6%88%98","title":"客户端安全加密的思考和实战.md","mdsource":"md/客户端安全加密的思考和实战.md","date":" 2017/02/18 21:53:33","category":"几年后回看会觉得写的太烂"},"content":"title: 客户端安全加密的思考和实战\ndate: 2017/02/18 21:53:33\nupdated: 2017/02/19 16:58:41\ncategories:\n- 技术\n---\n本文是面向native安全设计。\n\u003e 大家所知道的android程序员再代码安全方面做的大多数仅仅是把代码放到到so里面就可以了，那么实际上这样子安全吗？\n实际上，我作为一个爱思考的android程序员，我连会hack玩的一些高端的东西都不会，也轻松破解你。\n\n# \n在参与一个项目时，发现安全加密需要客户端做，但是作为一个有代码精神的程序员，我有几个问题需要慎重参与跟同事考虑几个重要的问题：\n1.使用什么加密算法？\n2.算法怎么保密？\n3.key怎么做保密？\n4.hack常见的破解我本地代码的手段是什么？\n\n\n常见的大家都是去做对称加密， 来保证网络传输的数据安全性，算法大家一般都是AES，可能老的一些项目还在使用3DES算法，AES主要就是性能高所以目前大量放弃AES。\n# \n回到破解的方向考虑，我怎么防止被人破解：\n### 几种方案：\n 1.key存到so中:\n\u003e 作为一个开发者来说，你觉得key是加密的核心，你把key存到native中，然而，我反编译一下apk，从java代码里看到你的全部代码是AES算法，我觉得破解你的核心是key，我只要拿到你的key，看到你把key存到c中了，通过调用一个jni接口，就可以拿到你的key，这个时候我的破解方案就是，修改你的java代码，在代码里插入一行代码把jni取到的key打印到日志里，再二次打包运行即可。\n# \n2.key和算法都存在so中：\n\u003e 如果上面的破解者只是一个普通的android程序员，可能这个时候还是可以破解你的，他不再目的为了取到你的key，而是仅仅当作你的so只是一个加密算法而已，我不用去破解你的so，只需要知道怎么调用你即可，我编译一下你的apk，看下你的java代码，就看到你怎么调用了，我就可以在新项目里就可以调用。\n这样子的话，我有个高级的方案，就是防止二次打包，问题在于，这个时候我怎么防止你二次打包，这个解决方案就是keystore的md5或者hashcode，就是在java调用so中的加密算法时，c的代码里要先去检查一下当前应用的包名应用的keystore的hashcode。这个校验一定要在c里面做，java太容易篡改，于是会有下面一个安全方案：\n# \n3.key 和 算法同时在so中，并做防止二次打包的校验：\n\u003e 这个时候，做为一个android程序员我已经很难破解了，我看不到你的key，最多，我只能在反编译apk dex文件时看到你的jni接口的命名，大概看出你是aes算法加密，只是我拿不到你的key。但是，目前我已经几乎看到两个点。这个时候，作为一个android程序可能很难破解你了。\n普通android程序员大概只是知道你是一个aes算法，但是，我如果能拿到你的key，还是可以破解。\n这个时候，我用IDA去反汇编so，发现竟然直接看到了你的key，这个时候怎么防止我去反汇编呢？\nndk有个配置是符号表，可以用符号表存一些字符串，把这些东西存到符号表中，然后再ndk编译时使用隐藏符号表的方案。\nok，是的这是个好方案。\n在尝试之后发现反汇编之后确实无法看到key的字符串了。IDA和objdump两个软件都有尝试结果同样看不到字符串了。\n第一张，图我代码里使用了 `uint8_t AES_KEY[] = \"1234567890abcdef\";`\n![](assets/key.png)\n第二张图我反汇编之后，还可以看到这个字符串。\n![](assets/section.png)\n\n\n# \n4.key 和 算法同时在so中，并做防止二次打包的校验,在隐藏符号表\n\u003e 这个时候，IDA是不行了，然后作为一个linux用户，我想想别的方案，发现apt仓库里有个objdump，我用objdump反编译一下，直接就看到你key。\n那么现在怎么办呢？有个方案，就是我的代码里存的key并不是一个真实的key，我把key做一些变换之后才能用，变换的代码我写在c里面，调用so里面的加密算法之前，我需要先调用c的init方法，生成好真实的key。\n# \n5.非真实的key存在so中，再生成真实的key，同时给so，做防止二次打包的校验\n\u003e 那么，我想办法还是可以破解你，我利用堆栈溢出从内存地址中取到你生成好的key。\n这时候，从这个攻防的等级逐渐加深，你会发现，原来key是非常不安全，总能想办法破解你，拿到你的key。\n# \n## 加密的核心无非就是两点：\n\u003e - 1.加密算法\n\u003e - 2.key\n算法方面除非你用自定义加密算法，否则很难保证不被人猜到，就那么常见的几种加密方式，AES，DES杂七杂八。\n那么，key的安全性设计就是更加的难了，只要你的key写在代码里，或者通过运行时生成的方式生成再内存中，我总是可以详尽办法拿到你的key。\n这样子的话，算法和key都很好搞定。\n\n# 所以\n最好的安全设计方案是自定义加密啊算法，在AES上面大量的修改，或者在Base64上做大量修改，c的代码被打包成机器码之后不但很难看懂，而且几乎没法二次打包，另外就是本地客户端不存key，也不通过服务端下去发key。\n几个常见的例子：\n##《模仿游戏》\n模仿游戏中德国采用的“英格码”无法破译，他的涉及思想就是网络传输中不发送key，同时没有一个固定的key，防止你去破解，就是动态key技术，导致你就算抓到他的秘文用超级计算机取暴力破解，破解出来也已经是当时的key了，你再去破解今天的数据的时候，key已经变了。\n这个是到动态key的涉及思想。\n\n## SSH的设计思想\n本机电脑上存储一个key，server端存储一个key，使用者一般通过key访问server，key涉及的特别的复杂，就算超级计算机破解也需要很长时间，如果用户发现自己的key被破解了，那么直接后台删除掉这个key重新生成一个key。这也是一种动态key设计思想，只不过他的变化规律无迹可循，而且用户可以再自己帐号被盗之后重置加密key。\n\n# \n这都是针对你的平台田地多，防止专业的破解团体来说的，而针对小的破解团体的话，你只要保证算法不被猜到，同时客户端不存key，而且不在网络传输的传递key即可提升破解难度。\n\n    想起曾经参加安卓巴士搞得一个安全方面的座谈会，我靠，360和阿里聚安全的大佬在台上信誓旦旦的说只要你把所有的代码放到native去实现，安全就已经提升了很高的等级，但是后来自己尝试破解native才知道，他妈的都是狗屁，破解native也特么的很简单。\n\n#  反汇编可以看到很多东西\n1.方法名：就可以看到你的加密算法了，这个时候你可以用JniOnload去做映射，防止被看到方法名。\n2.代码里写的string，所以key完全不能存到代码里。\n\n## 所以，为了防止被反汇编，有一些方案去帮助你\n\n利用使用O-LLVM在NDK打包so时进行混淆处理，增加那些专门做逆向编程的人的破解难度。\n如果本地非要存字符串，请不要存真实的，而是需要经过转换的字符，先存一个非真实字符到字符表，再配置隐藏字符表，然后运行时不能把key生成到一个static字段中，这样子很容易利用堆栈溢出pop出你的值，所以就算做本地转换也请用短生命域的临时变量去做，用完即可丢弃，c的释放内存速度超级快，只要引用计数降低到0即可释放，也就是说这段加密算法走完，key就丢弃了。\n例子代码：\n```\nstatic char* base_key=\"HJDKHFDSJFDFHA324723894djksfh\";\n\nchar* encode(Stirng str)\n{\n    return encode(str,getRealKey(base_key));\n}\n\nchar* encode(char* str,char* key)\n{\n    char * strEncode;\n    //todo something\n    return strEncode;\n}\n\nchar * getRealKey(char* base)\n{\n    char* realk=\"\";\n\n    //TODO something\n    return realk;\n}\n```\n这样子，你代码里并没有存真实的key，然后NDK打包又经过混淆，做逆向的人就很难从汇编中看出你的生成key 的算法了，想要利用堆栈溢出pop出你存在静态变量里的key也拿不到真实的key，而动态字段存在内存空间中的时间1毫秒都不到根本不能pop出。\n\n\n## 鸣谢\n\n\u003e https://www.linux.com/blog/4-ways-password-could-be-hacked-using-common-linux-tools","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8%E5%8A%A0%E5%AF%86%E7%9A%84%E6%80%9D%E8%80%83%E5%92%8C%E5%AE%9E%E6%88%98"},"buildId":"HT0wMZc9WfQm5UQ_5R-LL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>