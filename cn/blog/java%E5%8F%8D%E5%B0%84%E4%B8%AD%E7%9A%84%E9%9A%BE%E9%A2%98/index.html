<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>java反射中的难题.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="java反射中的难题.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="java反射中的难题.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2016/07/04 14:24:18"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel vubbuv gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-f7777f3ea9ebdd54.js" defer=""></script><script src="/_next/static/HT0wMZc9WfQm5UQ_5R-LL/_buildManifest.js" defer=""></script><script src="/_next/static/HT0wMZc9WfQm5UQ_5R-LL/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:absolute;top:22px;right:15px;height:100px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-style-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">java反射中的难题.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2016/07/04 14:24:18</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: java反射中的难题
date: 2016/07/04 14:24:18
updated: 2016/11/25 11:35:54
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<h2>1.访问私有对象（这个是比较简单，不算是难题）</h2>
<p>使用反射:</p>
<pre><code>        Field field[] = reClass.getDeclaredFields();
        field[0].setAccessible(true);
        field[0].set(obj, value);//给obj的一个属性设置value
</code></pre>
<h2>2.访问私有方法 （这个是比较简单，不算是难题）</h2>
<pre><code>    Method[] methods = reClass.getDeclaredMethods();
    methods[0].setAccessible(true);
    methods[i].invoke(obj)；//调用obj的一个带参数方法
</code></pre>
<h2>3.某个类使用private修饰了无参构造函数()</h2>
<pre><code>//使用私有构造函数创建实例化这个对象
    Constructor[] constructors = cls.getDeclaredConstructors();
	constructors[0].setAccessible(true);
	constructors[0].newInstance( )
</code></pre>
<h2>4.某个类使用private修饰了带参构造函数,如果你特么的还非要访问这个带参构造函数的话</h2>
<pre><code>public class FooCls {

    private FooCls(int i)
    {}
}


//实例化带参私有构造函数
    int i=0;
    Constructor[] constructors = cls.getDeclaredConstructors();
	constructors[0].setAccessible(true);
	constructors[0].newInstance(i);
</code></pre>
<h2>5.实例化内部类 （这个也是很困难）</h2>
<pre><code>    /**
     * 解决内部类无法构造问题
     * @param parentClass  必须提供父类 否则无法实例化内部类
     * @param reClass  内部类class
     * @return 实例化之后的内部类对象
     * @throws IllegalAccessException
     * @throws InstantiationException
     * @throws InvocationTargetException
     */
private Object createInnerClsObj(Class parentClass,Class reClass) throws IllegalAccessException, InstantiationException, InvocationTargetException {

        Object  parent=createObj(parentClass);

        Constructor[] cons = reClass.getDeclaredConstructors();//强制让 private 构造函数可以访问
        cons[0].setAccessible(true);
        return cons[0].newInstance(parent);// 调用无参构造函数  只是子类的构建需要父类的支持
    }
    
    
    private Object createObj(Class reClass) throws IllegalAccessException, InvocationTargetException, InstantiationException {

        Constructor[] cons = reClass.getDeclaredConstructors();//强制让 private 构造函数可以访问
        cons[0].setAccessible(true);
        return cons[0].newInstance();// 调用无参构造函数
    }
</code></pre>
<h2>6.类只提供了带参构造函数，想要实例化这个对象并通过无参构造去实例化</h2>
<pre><code>因为你只有带参构造函数，所以这里想要使用无参构造就变得异常艰难，java官方设计就不想让你这么做，我找了很多方案都发现没有这种方案。所以我选择试试fastjso怎样。
</code></pre>
<p>测试，发现其实fastjson也没有实现这个功能，我用fastjsonparse字符串的时候，一旦给的一个class只有一个带参的构造函数，类似上面<strong>4</strong>的，他就无法通过反射帮我实例化了，直接返回空对象回来。</p>
<p>测试用代码如下:</p>
<pre><code>public class FooCls {

    public FooCls(int i)
    {}
    int  els=0;
}

        //测试
        QMJSONHelper qmjsonHelper=new QMJSONHelper(&quot;{\&quot;els\&quot;:1}&quot;);
        FooCls foo=(FooCls)qmjsonHelper.parse2Model(FooCls.class);
        Log.d(&quot;foo&quot;,foo.toString());
    

</code></pre>
<p>后来，实验Gson竟然是可以得到这个对象的。666！！ 谷歌团队黑科技！！</p>
<h1>不行我要学习。</h1>
<p>仔细阅读GSON的源码，并且进去调试，发现<code>UnsafeAllocator</code>这个类。内部使用反射得到了<code>Unsafe</code>这个类，但是这个类压根就没有开放出来，我无法引用这个类。所以谷歌故意通过Class.forName()去得到这个类，然后执行了这个类的一个static方法。</p>
<pre><code>public abstract class UnsafeAllocator {
  public abstract &lt;T&gt; T newInstance(Class&lt;T&gt; c) throws Exception;

  public static UnsafeAllocator create() {
    // try JVM
    // public class Unsafe {
    //   public Object allocateInstance(Class&lt;?&gt; type);
    // }
    try {
      Class&lt;?&gt; unsafeClass = Class.forName(&quot;sun.misc.Unsafe&quot;);
      Field f = unsafeClass.getDeclaredField(&quot;theUnsafe&quot;);
      f.setAccessible(true);
      final Object unsafe = f.get(null);
      final Method allocateInstance = unsafeClass.getMethod(&quot;allocateInstance&quot;, Class.class);
      return new UnsafeAllocator() {
        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public &lt;T&gt; T newInstance(Class&lt;T&gt; c) throws Exception {
          assertInstantiable(c);
          return (T) allocateInstance.invoke(unsafe, c);
        }
      };
    } catch (Exception ignored) {
    }

    // try dalvikvm, post-gingerbread
    // public class ObjectStreamClass {
    //   private static native int getConstructorId(Class&lt;?&gt; c);
    //   private static native Object newInstance(Class&lt;?&gt; instantiationClass, int methodId);
    // }
    try {
      Method getConstructorId = ObjectStreamClass.class
          .getDeclaredMethod(&quot;getConstructorId&quot;, Class.class);
      getConstructorId.setAccessible(true);
      final int constructorId = (Integer) getConstructorId.invoke(null, Object.class);
      final Method newInstance = ObjectStreamClass.class
          .getDeclaredMethod(&quot;newInstance&quot;, Class.class, int.class);
      newInstance.setAccessible(true);
      return new UnsafeAllocator() {
        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public &lt;T&gt; T newInstance(Class&lt;T&gt; c) throws Exception {
          assertInstantiable(c);
          return (T) newInstance.invoke(null, c, constructorId);
        }
      };
    } catch (Exception ignored) {
    }

    // try dalvikvm, pre-gingerbread
    // public class ObjectInputStream {
    //   private static native Object newInstance(
    //     Class&lt;?&gt; instantiationClass, Class&lt;?&gt; constructorClass);
    // }
    try {
      final Method newInstance = ObjectInputStream.class
          .getDeclaredMethod(&quot;newInstance&quot;, Class.class, Class.class);
      newInstance.setAccessible(true);
      return new UnsafeAllocator() {
        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public &lt;T&gt; T newInstance(Class&lt;T&gt; c) throws Exception {
          assertInstantiable(c);
          return (T) newInstance.invoke(null, c, Object.class);
        }
      };
    } catch (Exception ignored) {
    }

    // give up
    return new UnsafeAllocator() {
      @Override
      public &lt;T&gt; T newInstance(Class&lt;T&gt; c) {
        throw new UnsupportedOperationException(&quot;Cannot allocate &quot; + c);
      }
    };
  }

  /**
   * Check if the class can be instantiated by unsafe allocator. If the instance has interface or abstract modifiers
   * throw an {@link UnsupportedOperationException}
   * @param c instance of the class to be checked
   */
  private static void assertInstantiable(Class&lt;?&gt; c) {
    int modifiers = c.getModifiers();
    if (Modifier.isInterface(modifiers)) {
      throw new UnsupportedOperationException(&quot;Interface can&#x27;t be instantiated! Interface name: &quot; + c.getName());
    }
    if (Modifier.isAbstract(modifiers)) {
      throw new UnsupportedOperationException(&quot;Abstract class can&#x27;t be instantiated! Class name: &quot; + c.getName());
    }
  }
}
</code></pre>
<h1></h1>
<pre><code>    //用法很简单：
    final UnsafeAllocator unsafeAllocator = UnsafeAllocator.create();
    return unsafeAllocator.newInstance(reClass);

</code></pre>
<p>用Gson里面这个UnsafeAllocator 可以完美实现不开放默认构造函数的类的实例化。这个方案同时可以解决<strong>4</strong>的问题。</p>
<h2>7.取得泛型的类型，并new出来(这个很困难，多数人都告诉我：不能)</h2>
<pre><code>//给出我在 MVP中的例子

public abstract class BaseCommActivity&lt;P extends BaseCommPresenter&gt; extends FragmentActivity implements IBaseCommView,OnClickListener,OnReciverListener {


    protected P presenter;

    public BaseCommActivity() {

        try {
            //执行默认 构造函数
//            presenter = getPsClass().newInstance();

            Class&lt;P&gt; cls=((Class)((ParameterizedType)getClass().getGenericSuperclass()).getActualTypeArguments()[0]);

            Constructor[] constructors=cls.getDeclaredConstructors();
            constructors[0].setAccessible(true);//这句代码 意义不大 仅仅防止构造函数private

            presenter=cls.newInstance();

        } catch (InstantiationException e) {
            e.printStackTrace();//这个异常通常不会发生 除非你的泛型类型是 Integer Boolean Long 这些
        } catch (IllegalAccessException e) {
            e.printStackTrace();  //
        }

        presenter.setIView(this);
    }

</code></pre>
<h2>Java Doc上的说明</h2>
<pre><code>getFields()获得某个类的所有的公共（public）的字段，包括父类。 

getDeclaredFields()获得某个类的所有申明的字段，即包括public、private和proteced，但是不包括父类的申明字段。 

同样类似的还有getConstructors()和getDeclaredConstructors()，getMethods()和getDeclaredMethods()。



Method getDeclaredMethod(String name, Class… parameterTypes)d 
      返回一个 Method 对象，该对象反映此 Class 对象所表示的类或接口的指定已声明方法。 
Method[] getDeclaredMethods() 
      返回 Method 对象的一个数组，这些对象反映此 Class 对象表示的类或接口声明的所有方法，包括公共、保护、默认（包）访问和私有方法，但不包括继承的方法。 
Method getMethod(String name, Class… parameterTypes) 
      返回一个 Method 对象，它反映此 Class 对象所表示的类或接口的指定公共成员方法。 
Method[] getMethods() 
      返回一个包含某些 Method 对象的数组，这些对象反映此 Class 对象所表示的类或接口（包括那些由该类或接口声明的以及从超类和超接口继承的那些的类或接口）的公共 member 方法。 
getDeclaredField(String name) 
      返回一个 Field 对象，该对象反映此 Class 对象所表示的类或接口的指定已声明字段。 
Field[] getDeclaredFields() 
      返回 Field 对象的一个数组，这些对象反映此 Class 对象所表示的类或接口所声明的所有字段，包括公共、保护、默认（包）访问和私有字段，但不包括继承的字段。
</code></pre>
<h1></h1>
<h1></h1>
<blockquote>
<ul>
<li><a href="https://dunwood.blogspot.com/2004/05/instantiate-java-class-that-has.html">https://dunwood.blogspot.com/2004/05/instantiate-java-class-that-has.html</a></li>
</ul>
</blockquote></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"java%E5%8F%8D%E5%B0%84%E4%B8%AD%E7%9A%84%E9%9A%BE%E9%A2%98","title":"java反射中的难题.md","mdsource":"md/java反射中的难题.md","date":" 2016/07/04 14:24:18","category":"几年后回看会觉得写的太烂"},"content":"title: java反射中的难题\ndate: 2016/07/04 14:24:18\nupdated: 2016/11/25 11:35:54\ncategories:\n- 技术\n---\n## 1.访问私有对象（这个是比较简单，不算是难题）\n\n使用反射:\n```\n        Field field[] = reClass.getDeclaredFields();\n        field[0].setAccessible(true);\n        field[0].set(obj, value);//给obj的一个属性设置value\n```\n\n## 2.访问私有方法 （这个是比较简单，不算是难题）\n\n        Method[] methods = reClass.getDeclaredMethods();\n        methods[0].setAccessible(true);\n        methods[i].invoke(obj)；//调用obj的一个带参数方法\n\n## 3.某个类使用private修饰了无参构造函数()\n```\n//使用私有构造函数创建实例化这个对象\n    Constructor[] constructors = cls.getDeclaredConstructors();\n\tconstructors[0].setAccessible(true);\n\tconstructors[0].newInstance( )\n```\n\n## 4.某个类使用private修饰了带参构造函数,如果你特么的还非要访问这个带参构造函数的话\n\n```\npublic class FooCls {\n\n    private FooCls(int i)\n    {}\n}\n\n\n//实例化带参私有构造函数\n    int i=0;\n    Constructor[] constructors = cls.getDeclaredConstructors();\n\tconstructors[0].setAccessible(true);\n\tconstructors[0].newInstance(i);\n```\n## 5.实例化内部类 （这个也是很困难）\n\n```\n    /**\n     * 解决内部类无法构造问题\n     * @param parentClass  必须提供父类 否则无法实例化内部类\n     * @param reClass  内部类class\n     * @return 实例化之后的内部类对象\n     * @throws IllegalAccessException\n     * @throws InstantiationException\n     * @throws InvocationTargetException\n     */\nprivate Object createInnerClsObj(Class parentClass,Class reClass) throws IllegalAccessException, InstantiationException, InvocationTargetException {\n\n        Object  parent=createObj(parentClass);\n\n        Constructor[] cons = reClass.getDeclaredConstructors();//强制让 private 构造函数可以访问\n        cons[0].setAccessible(true);\n        return cons[0].newInstance(parent);// 调用无参构造函数  只是子类的构建需要父类的支持\n    }\n    \n    \n    private Object createObj(Class reClass) throws IllegalAccessException, InvocationTargetException, InstantiationException {\n\n        Constructor[] cons = reClass.getDeclaredConstructors();//强制让 private 构造函数可以访问\n        cons[0].setAccessible(true);\n        return cons[0].newInstance();// 调用无参构造函数\n    }\n```\n\n## 6.类只提供了带参构造函数，想要实例化这个对象并通过无参构造去实例化\n\n    因为你只有带参构造函数，所以这里想要使用无参构造就变得异常艰难，java官方设计就不想让你这么做，我找了很多方案都发现没有这种方案。所以我选择试试fastjso怎样。\n    \n测试，发现其实fastjson也没有实现这个功能，我用fastjsonparse字符串的时候，一旦给的一个class只有一个带参的构造函数，类似上面**4**的，他就无法通过反射帮我实例化了，直接返回空对象回来。\n\n测试用代码如下:\n```\npublic class FooCls {\n\n    public FooCls(int i)\n    {}\n    int  els=0;\n}\n\n        //测试\n        QMJSONHelper qmjsonHelper=new QMJSONHelper(\"{\\\"els\\\":1}\");\n        FooCls foo=(FooCls)qmjsonHelper.parse2Model(FooCls.class);\n        Log.d(\"foo\",foo.toString());\n    \n\n```\n后来，实验Gson竟然是可以得到这个对象的。666！！ 谷歌团队黑科技！！\n\n\n# 不行我要学习。\n仔细阅读GSON的源码，并且进去调试，发现`UnsafeAllocator`这个类。内部使用反射得到了`Unsafe`这个类，但是这个类压根就没有开放出来，我无法引用这个类。所以谷歌故意通过Class.forName()去得到这个类，然后执行了这个类的一个static方法。\n```\npublic abstract class UnsafeAllocator {\n  public abstract \u003cT\u003e T newInstance(Class\u003cT\u003e c) throws Exception;\n\n  public static UnsafeAllocator create() {\n    // try JVM\n    // public class Unsafe {\n    //   public Object allocateInstance(Class\u003c?\u003e type);\n    // }\n    try {\n      Class\u003c?\u003e unsafeClass = Class.forName(\"sun.misc.Unsafe\");\n      Field f = unsafeClass.getDeclaredField(\"theUnsafe\");\n      f.setAccessible(true);\n      final Object unsafe = f.get(null);\n      final Method allocateInstance = unsafeClass.getMethod(\"allocateInstance\", Class.class);\n      return new UnsafeAllocator() {\n        @Override\n        @SuppressWarnings(\"unchecked\")\n        public \u003cT\u003e T newInstance(Class\u003cT\u003e c) throws Exception {\n          assertInstantiable(c);\n          return (T) allocateInstance.invoke(unsafe, c);\n        }\n      };\n    } catch (Exception ignored) {\n    }\n\n    // try dalvikvm, post-gingerbread\n    // public class ObjectStreamClass {\n    //   private static native int getConstructorId(Class\u003c?\u003e c);\n    //   private static native Object newInstance(Class\u003c?\u003e instantiationClass, int methodId);\n    // }\n    try {\n      Method getConstructorId = ObjectStreamClass.class\n          .getDeclaredMethod(\"getConstructorId\", Class.class);\n      getConstructorId.setAccessible(true);\n      final int constructorId = (Integer) getConstructorId.invoke(null, Object.class);\n      final Method newInstance = ObjectStreamClass.class\n          .getDeclaredMethod(\"newInstance\", Class.class, int.class);\n      newInstance.setAccessible(true);\n      return new UnsafeAllocator() {\n        @Override\n        @SuppressWarnings(\"unchecked\")\n        public \u003cT\u003e T newInstance(Class\u003cT\u003e c) throws Exception {\n          assertInstantiable(c);\n          return (T) newInstance.invoke(null, c, constructorId);\n        }\n      };\n    } catch (Exception ignored) {\n    }\n\n    // try dalvikvm, pre-gingerbread\n    // public class ObjectInputStream {\n    //   private static native Object newInstance(\n    //     Class\u003c?\u003e instantiationClass, Class\u003c?\u003e constructorClass);\n    // }\n    try {\n      final Method newInstance = ObjectInputStream.class\n          .getDeclaredMethod(\"newInstance\", Class.class, Class.class);\n      newInstance.setAccessible(true);\n      return new UnsafeAllocator() {\n        @Override\n        @SuppressWarnings(\"unchecked\")\n        public \u003cT\u003e T newInstance(Class\u003cT\u003e c) throws Exception {\n          assertInstantiable(c);\n          return (T) newInstance.invoke(null, c, Object.class);\n        }\n      };\n    } catch (Exception ignored) {\n    }\n\n    // give up\n    return new UnsafeAllocator() {\n      @Override\n      public \u003cT\u003e T newInstance(Class\u003cT\u003e c) {\n        throw new UnsupportedOperationException(\"Cannot allocate \" + c);\n      }\n    };\n  }\n\n  /**\n   * Check if the class can be instantiated by unsafe allocator. If the instance has interface or abstract modifiers\n   * throw an {@link UnsupportedOperationException}\n   * @param c instance of the class to be checked\n   */\n  private static void assertInstantiable(Class\u003c?\u003e c) {\n    int modifiers = c.getModifiers();\n    if (Modifier.isInterface(modifiers)) {\n      throw new UnsupportedOperationException(\"Interface can't be instantiated! Interface name: \" + c.getName());\n    }\n    if (Modifier.isAbstract(modifiers)) {\n      throw new UnsupportedOperationException(\"Abstract class can't be instantiated! Class name: \" + c.getName());\n    }\n  }\n}\n```\n# \n```\n    //用法很简单：\n    final UnsafeAllocator unsafeAllocator = UnsafeAllocator.create();\n    return unsafeAllocator.newInstance(reClass);\n\n```\n\n用Gson里面这个UnsafeAllocator 可以完美实现不开放默认构造函数的类的实例化。这个方案同时可以解决**4**的问题。\n\n## 7.取得泛型的类型，并new出来(这个很困难，多数人都告诉我：不能)\n```\n//给出我在 MVP中的例子\n\npublic abstract class BaseCommActivity\u003cP extends BaseCommPresenter\u003e extends FragmentActivity implements IBaseCommView,OnClickListener,OnReciverListener {\n\n\n    protected P presenter;\n\n    public BaseCommActivity() {\n\n        try {\n            //执行默认 构造函数\n//            presenter = getPsClass().newInstance();\n\n            Class\u003cP\u003e cls=((Class)((ParameterizedType)getClass().getGenericSuperclass()).getActualTypeArguments()[0]);\n\n            Constructor[] constructors=cls.getDeclaredConstructors();\n            constructors[0].setAccessible(true);//这句代码 意义不大 仅仅防止构造函数private\n\n            presenter=cls.newInstance();\n\n        } catch (InstantiationException e) {\n            e.printStackTrace();//这个异常通常不会发生 除非你的泛型类型是 Integer Boolean Long 这些\n        } catch (IllegalAccessException e) {\n            e.printStackTrace();  //\n        }\n\n        presenter.setIView(this);\n    }\n\n```\n\n\n\n## Java Doc上的说明\n\n\n    getFields()获得某个类的所有的公共（public）的字段，包括父类。 \n\n    getDeclaredFields()获得某个类的所有申明的字段，即包括public、private和proteced，但是不包括父类的申明字段。 \n\n    同样类似的还有getConstructors()和getDeclaredConstructors()，getMethods()和getDeclaredMethods()。\n\n\n\n    Method getDeclaredMethod(String name, Class… parameterTypes)d \n          返回一个 Method 对象，该对象反映此 Class 对象所表示的类或接口的指定已声明方法。 \n    Method[] getDeclaredMethods() \n          返回 Method 对象的一个数组，这些对象反映此 Class 对象表示的类或接口声明的所有方法，包括公共、保护、默认（包）访问和私有方法，但不包括继承的方法。 \n    Method getMethod(String name, Class… parameterTypes) \n          返回一个 Method 对象，它反映此 Class 对象所表示的类或接口的指定公共成员方法。 \n    Method[] getMethods() \n          返回一个包含某些 Method 对象的数组，这些对象反映此 Class 对象所表示的类或接口（包括那些由该类或接口声明的以及从超类和超接口继承的那些的类或接口）的公共 member 方法。 \n    getDeclaredField(String name) \n          返回一个 Field 对象，该对象反映此 Class 对象所表示的类或接口的指定已声明字段。 \n    Field[] getDeclaredFields() \n          返回 Field 对象的一个数组，这些对象反映此 Class 对象所表示的类或接口所声明的所有字段，包括公共、保护、默认（包）访问和私有字段，但不包括继承的字段。\n\n\n# \n# \n\u003e - https://dunwood.blogspot.com/2004/05/instantiate-java-class-that-has.html\n\n\n","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"java%E5%8F%8D%E5%B0%84%E4%B8%AD%E7%9A%84%E9%9A%BE%E9%A2%98"},"buildId":"HT0wMZc9WfQm5UQ_5R-LL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>