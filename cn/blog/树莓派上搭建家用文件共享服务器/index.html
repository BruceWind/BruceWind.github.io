<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>树莓派上搭建家用文件共享服务器.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="树莓派上搭建家用文件共享服务器.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="树莓派上搭建家用文件共享服务器.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2017/07/02 23:04:07"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel 1k33q06 gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-c0566a06cafc2ea3.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_buildManifest.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall mui-style-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">树莓派上搭建家用文件共享服务器.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2017/07/02 23:04:07</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: 树莓派上搭建家用文件共享服务器
date: 2017/07/02 23:04:07
updated: 2018/03/22 14:11:51
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>大家都会遇到这么个蛋疼的问题，平常用单反拍摄的一些照片太大了，一张照片5M+的大小，太吃SD卡，随便出去游玩几天就拍了一两百张，文件备份是一个需求，另外就是预览，下载，观看，发朋友圈的需求太多，太杂，相机那个小屏幕根本无法满足我的这些需求。另外还有我还有局域网大文件中转站的需求，百度云盘根本无法满足我的需求。急需一个高达上的家庭局域网文件共享中心。</p>
<h2>一.硬件选择：</h2>
<h1></h1>
<p>既然是文件共享中心吗！我肯定需要一台文件服务器，你懂得屌丝租房空间本来就小，再整一个那么大的服务器放家里太扯淡了。</p>
<h1></h1>
<p>正好我的树莓派在路由器盒子里躺着，他一直在我的路由器盒子里跟一堆无线设备一起工作着，而且树莓派我装的是128G的高速SD卡，4核1.2的CPU，而我只是偶尔拿它测试下下载文件速度，公司经常下载文件下载不了，不确定是公司网不好还是对方服务器不好的时候，我就远程ssh到家里的树莓派上，对比下下载速率，其他时间它基本都没有用过了。
<img src="assets/raspberry-1.jpg" alt=""/>
<img src="assets/sapberry-0.jpg" alt="这个才是pi"/></p>
<h1></h1>
<h2>二.软件选择：</h2>
<p>另外软件方面也要精挑细选，除了照片，他还要 承担器大文件中转站的功能。
私有云盘是个好东西。即可以做文件存储，而且对照片友好，同时管理文档视频都是不错的选择。
开源的私有云盘都不错，只是不一定是我想要的，即对用户有好，UI大气上档次，又长期持续维护。
最后发现nextcloud是个不错的选择。</p>
<h2>三.测试安装：</h2>
<p>教程不多数，国内比较少，主要都是国外的教程，想要自己实现的，自己去搜一下。
因为测试安装过程，中间万一出现差错，容易发生可怕的事情，所以我在网上就租了个VPS测试了下，花了几个美分搞定。
我把测试过程的命令保存到shell文件里，到树莓派安装时就是一键式66666666666666666666666666。</p>
<h2>四.真机安装：</h2>
<p>直接上树莓派开始安装。我拷贝刚刚那个shell，一个shell丢过去搞定。</p>
<pre><code class="language-shell">sudo apt-get install apache2 # maybe need input &quot;y&quot;

 sudo apt-get -y install php5
 sudo apt-get -y install php5-gd
 sudo apt-get -y install sqlite
 sudo apt-get -y install php5-sqlite
 sudo apt-get -y install php5-curl

sudo service apache2 restart
sudo mv nextcloud-12.0.0.zip /var/www/html
cd /var/www/html
sudo unzip -q nextcloud-12.0.0.zip


sudo mkdir -p /var/www/html/nextcloud/data
sudo chown www-data:www-data /var/www/html/nextcloud/data
sudo chmod 750 /var/www/html/nextcloud/data

ls -ld /var/www/html/nextcloud/data
# drwxr-x--- 2 www-data www-data 4096 May 27 18:45 /var/www/html/nextcloud/data
cd /var/www/html/nextcloud
sudo chown www-data:www-data config apps

</code></pre>
<p>到此，已经安装配置完毕，现在需要在浏览器中打开树莓派的ip地址。
这个时候，要设置一个管理员账户密码，然后等他loading完就好了，loading比较久，毕竟是软件配置的过程，就像你第一次安装wordpress，CMS之类的服务器端软件一样，是要等两分钟。</p>
<h2>遇到坑爹的问题：</h2>
<p>1.我安装这个之后打开树莓派ip，出现的竟然是nginx，而且404，我草，我的apache呢！！想想，好像nginx是我很久以前自己装的，之前在树莓派搭建的rtmp流媒体服务器，很久没用忘记了这一出。果断卸载nginx，当然端口分开也是一种选择。</p>
<pre><code>sudo apt-get remove nginx nginx-common
sudo service apache2 restart  #需要重启apache
</code></pre>
<p>重启apache就好了。</p>
<p>2.默认上传限制文件最大2M</p>
<p>这个nextcloud默认的文件大小完全不够啊！！！单文件才2M，随便一个文件都多大了。
修改默认的上传文件限制：</p>
<pre><code>sudo nano  /etc/php5/apache2/php.ini
</code></pre>
<p>进去修改这两行：</p>
<pre><code>upload_max_filesize = 2Mb
post_max_size = 8Mb
</code></pre>
<p>upload_max_filesize 是单个文件的限制。
post_max_size 是post请求的整个主体的限制，可能包括多个文件。</p>
<h1></h1>
<p>3.客户端？？what？？
居然还有客户端？是的，也需要客户端，客户端appstore免费！
发现h5的体验也不差！非常赞。用h5上传文件也非常的棒！！6666！
但是,h5不能在浏览器后台时继续传输文件，而客户端可以的。</p>
<h1></h1>
<p>4.上传1M/s ？？？</p>
<p>wtf!!! 为何这么慢，查了很久的php，apache的原因，还是没查到，从浏览器上传换到客户端上传还是这么慢，后来基本排除软件原因之后，改用硬件原因，网络！！！   我特么直接给树莓派插上网线之后，就3-4M的速度了，远程ssh进去看IO，IO也开始忙了，很多时候，io的占用是超过50%，这就看起来正常了，3-4M这个真的只能看硬件了IO繁忙了，CPU消耗也上来了。</p>
<p>5.小文件上传速度比3M还慢？
对的，这个是要更慢，小文件的上传速度依旧还是3M多，但是因为涉及到数据库，http响应，解析文件类型，生成预览，操作逻辑很复杂，会更加慢！！所以，提供了sync客户端类似网盘，直接往里面一拖 就不管了。</p>
<p>6.如何重置管理员密码？</p>
<p>最好配置邮箱服务器，这样子密码丢了，可以用邮箱找回！
如果没有设置邮箱也没关系，可以强制修改密码
命令如下：
sudo -u root php /var/www/nextcloud/occ user:resetpassword admin</p>
<h2>体验：</h2>
<p>操作界面：
这个界面跟百度云盘的界面超级像，我都有点搞不清谁抄谁的呢！
大量时间我都在使用网页端操作，客户端几乎没有使用，因为我尝试了客户端对上传下载的速度并没有提升。当然，他是跨平台软件，如果非要用客户端的话，我作为一个linux用户也有客户端。
网页打开，要用敲很长一段ip地址，我很烦，所以就直接在路由器里做了host，自定义一个域名，比如myfile.com指向那个局域网ip，智能路由嘛玩法多。
上传：相机卡拔出来插在电脑上，文件往网页里一拖，等他慢慢传完，另外就是实际此时大文件还支持断点续传。
下载：这个真的是超级快，毕竟没有上传时复杂的数据库杂七杂八的逻辑处理。</p>
<pre><code>配上一张家里的无线设备箱合上盖子的照片：
</code></pre>
<p><img src="assets/raspberry-2.jpg" alt=""/></p>
<pre><code> 兔斯基每天都见，激励着我勇敢前行。
</code></pre>
<h2>其他功能</h2>
<p>nextcloud还有其他一些功能，比如类似云盘的sync功能，这个也提供，甚至还有任务，日历，邮，箱 视频会议，等等功能。。。。。居然还有音乐播放器功能！！绝了。当然那些杂七杂八的功能需要手动配置插件了。</p>
<hr/>
<h3>2017/07/21 补充</h3>
<p>优化了一波上传速度：
现在下载已经突破12M了，上传接近4M了。非常快。由于树莓派是百兆网卡，最大的下载速度被限制在100mbps，路由器也是100M网口,那么理论上可以做到的最大下载速度12.5MB/S,12M的速度已经接近极限了。
这次的优化方案是：参考我自己的服务器TCP优化的配置，树莓派上也优化了一波，上传下载都非常快了。</p>
<h3>2017/08/11 :</h3>
<p>nextcloud 升级：
先设置目录权限，方便php下载到这个目录里去。</p>
<p>sudo chown -R www-data:www-data /var/www/nextcloud
然后在后台点击更新按钮即可升级了。</p>
<hr/>
<p>感谢：</p>
<p><a href="https://stackoverflow.com/questions/7754133/php-post-max-size-overrides-upload-max-filesize">stackoverflow：php-post-max-size-overrides-upload-max-filesize</a></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"树莓派上搭建家用文件共享服务器","title":"树莓派上搭建家用文件共享服务器.md","mdsource":"md/树莓派上搭建家用文件共享服务器.md","date":" 2017/07/02 23:04:07","category":"几年后回看会觉得写的太烂"},"content":"title: 树莓派上搭建家用文件共享服务器\ndate: 2017/07/02 23:04:07\nupdated: 2018/03/22 14:11:51\ncategories:\n- 技术\n---\n大家都会遇到这么个蛋疼的问题，平常用单反拍摄的一些照片太大了，一张照片5M+的大小，太吃SD卡，随便出去游玩几天就拍了一两百张，文件备份是一个需求，另外就是预览，下载，观看，发朋友圈的需求太多，太杂，相机那个小屏幕根本无法满足我的这些需求。另外还有我还有局域网大文件中转站的需求，百度云盘根本无法满足我的需求。急需一个高达上的家庭局域网文件共享中心。\n\n## 一.硬件选择：\n#  \n既然是文件共享中心吗！我肯定需要一台文件服务器，你懂得屌丝租房空间本来就小，再整一个那么大的服务器放家里太扯淡了。\n#  \n正好我的树莓派在路由器盒子里躺着，他一直在我的路由器盒子里跟一堆无线设备一起工作着，而且树莓派我装的是128G的高速SD卡，4核1.2的CPU，而我只是偶尔拿它测试下下载文件速度，公司经常下载文件下载不了，不确定是公司网不好还是对方服务器不好的时候，我就远程ssh到家里的树莓派上，对比下下载速率，其他时间它基本都没有用过了。\n![](assets/raspberry-1.jpg)\n![这个才是pi](assets/sapberry-0.jpg)\n\n#  \n##  二.软件选择：\n另外软件方面也要精挑细选，除了照片，他还要 承担器大文件中转站的功能。\n私有云盘是个好东西。即可以做文件存储，而且对照片友好，同时管理文档视频都是不错的选择。\n开源的私有云盘都不错，只是不一定是我想要的，即对用户有好，UI大气上档次，又长期持续维护。\n最后发现nextcloud是个不错的选择。\n\n\n## 三.测试安装：\n教程不多数，国内比较少，主要都是国外的教程，想要自己实现的，自己去搜一下。\n因为测试安装过程，中间万一出现差错，容易发生可怕的事情，所以我在网上就租了个VPS测试了下，花了几个美分搞定。\n我把测试过程的命令保存到shell文件里，到树莓派安装时就是一键式66666666666666666666666666。\n\n## 四.真机安装：\n直接上树莓派开始安装。我拷贝刚刚那个shell，一个shell丢过去搞定。\n\n``` shell\nsudo apt-get install apache2 # maybe need input \"y\"\n\n sudo apt-get -y install php5\n sudo apt-get -y install php5-gd\n sudo apt-get -y install sqlite\n sudo apt-get -y install php5-sqlite\n sudo apt-get -y install php5-curl\n\nsudo service apache2 restart\nsudo mv nextcloud-12.0.0.zip /var/www/html\ncd /var/www/html\nsudo unzip -q nextcloud-12.0.0.zip\n\n\nsudo mkdir -p /var/www/html/nextcloud/data\nsudo chown www-data:www-data /var/www/html/nextcloud/data\nsudo chmod 750 /var/www/html/nextcloud/data\n\nls -ld /var/www/html/nextcloud/data\n# drwxr-x--- 2 www-data www-data 4096 May 27 18:45 /var/www/html/nextcloud/data\ncd /var/www/html/nextcloud\nsudo chown www-data:www-data config apps\n\n```\n到此，已经安装配置完毕，现在需要在浏览器中打开树莓派的ip地址。\n这个时候，要设置一个管理员账户密码，然后等他loading完就好了，loading比较久，毕竟是软件配置的过程，就像你第一次安装wordpress，CMS之类的服务器端软件一样，是要等两分钟。\n\n## 遇到坑爹的问题：\n1.我安装这个之后打开树莓派ip，出现的竟然是nginx，而且404，我草，我的apache呢！！想想，好像nginx是我很久以前自己装的，之前在树莓派搭建的rtmp流媒体服务器，很久没用忘记了这一出。果断卸载nginx，当然端口分开也是一种选择。\n```\nsudo apt-get remove nginx nginx-common\nsudo service apache2 restart  #需要重启apache\n```\n重启apache就好了。\n\n2.默认上传限制文件最大2M\n\n这个nextcloud默认的文件大小完全不够啊！！！单文件才2M，随便一个文件都多大了。\n修改默认的上传文件限制：\n\n    sudo nano  /etc/php5/apache2/php.ini\n\n进去修改这两行：\n\n    upload_max_filesize = 2Mb\n    post_max_size = 8Mb\n    \nupload_max_filesize 是单个文件的限制。\npost_max_size 是post请求的整个主体的限制，可能包括多个文件。\n\n# \n3.客户端？？what？？\n居然还有客户端？是的，也需要客户端，客户端appstore免费！\n发现h5的体验也不差！非常赞。用h5上传文件也非常的棒！！6666！\n但是,h5不能在浏览器后台时继续传输文件，而客户端可以的。\n\n#  \n4.上传1M/s ？？？ \n\nwtf!!! 为何这么慢，查了很久的php，apache的原因，还是没查到，从浏览器上传换到客户端上传还是这么慢，后来基本排除软件原因之后，改用硬件原因，网络！！！   我特么直接给树莓派插上网线之后，就3-4M的速度了，远程ssh进去看IO，IO也开始忙了，很多时候，io的占用是超过50%，这就看起来正常了，3-4M这个真的只能看硬件了IO繁忙了，CPU消耗也上来了。\n\n5.小文件上传速度比3M还慢？\n对的，这个是要更慢，小文件的上传速度依旧还是3M多，但是因为涉及到数据库，http响应，解析文件类型，生成预览，操作逻辑很复杂，会更加慢！！所以，提供了sync客户端类似网盘，直接往里面一拖 就不管了。\n\n6.如何重置管理员密码？\n\n最好配置邮箱服务器，这样子密码丢了，可以用邮箱找回！\n如果没有设置邮箱也没关系，可以强制修改密码\n命令如下：\nsudo -u root php /var/www/nextcloud/occ user:resetpassword admin\n\n## 体验：\n操作界面：\n这个界面跟百度云盘的界面超级像，我都有点搞不清谁抄谁的呢！\n大量时间我都在使用网页端操作，客户端几乎没有使用，因为我尝试了客户端对上传下载的速度并没有提升。当然，他是跨平台软件，如果非要用客户端的话，我作为一个linux用户也有客户端。\n网页打开，要用敲很长一段ip地址，我很烦，所以就直接在路由器里做了host，自定义一个域名，比如myfile.com指向那个局域网ip，智能路由嘛玩法多。\n上传：相机卡拔出来插在电脑上，文件往网页里一拖，等他慢慢传完，另外就是实际此时大文件还支持断点续传。\n下载：这个真的是超级快，毕竟没有上传时复杂的数据库杂七杂八的逻辑处理。\n\n\n    配上一张家里的无线设备箱合上盖子的照片：\n![](assets/raspberry-2.jpg)\n\n     兔斯基每天都见，激励着我勇敢前行。\n\n##  其他功能\n\nnextcloud还有其他一些功能，比如类似云盘的sync功能，这个也提供，甚至还有任务，日历，邮，箱 视频会议，等等功能。。。。。居然还有音乐播放器功能！！绝了。当然那些杂七杂八的功能需要手动配置插件了。\n__________\n### 2017/07/21 补充\n优化了一波上传速度：\n现在下载已经突破12M了，上传接近4M了。非常快。由于树莓派是百兆网卡，最大的下载速度被限制在100mbps，路由器也是100M网口,那么理论上可以做到的最大下载速度12.5MB/S,12M的速度已经接近极限了。\n这次的优化方案是：参考我自己的服务器TCP优化的配置，树莓派上也优化了一波，上传下载都非常快了。\n\n### 2017/08/11 :\nnextcloud 升级：\n先设置目录权限，方便php下载到这个目录里去。\n\n sudo chown -R www-data:www-data /var/www/nextcloud \n然后在后台点击更新按钮即可升级了。\n_______________________\n感谢：\n\n[stackoverflow：php-post-max-size-overrides-upload-max-filesize](https://stackoverflow.com/questions/7754133/php-post-max-size-overrides-upload-max-filesize)","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"树莓派上搭建家用文件共享服务器"},"buildId":"pUDExLTnYM1HHfZLuoalS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>