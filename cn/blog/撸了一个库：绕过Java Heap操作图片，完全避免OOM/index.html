<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>撸了一个库：绕过Java Heap操作图片，完全避免OOM.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="撸了一个库：绕过Java Heap操作图片，完全避免OOM.md - 开源"/><meta property="og:title" content="撸了一个库：绕过Java Heap操作图片，完全避免OOM.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2017/12/29 14:52:02"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel 1k33q06 gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-c0566a06cafc2ea3.js" defer=""></script><script src="/_next/static/zaycUZ6jvMLykcBwRP9wT/_buildManifest.js" defer=""></script><script src="/_next/static/zaycUZ6jvMLykcBwRP9wT/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall mui-style-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">撸了一个库：绕过Java Heap操作图片，完全避免OOM.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">开源<!-- --> | <!-- --> 2017/12/29 14:52:02</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: 撸了一个库：绕过Java Heap操作图片，完全避免OOM
date: 2017/12/29 14:52:02
updated: 2018/04/24 17:58:55
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>首先，请专心阅读，因为：这个库不能算是技术性突破，但是对国内大部分android开发者而言，都是打破常规的新认识，这里我要吹个牛了。</p>
<p>为什么这么说呢？你问你身边的同事，怎么操作图片避免OOM，都不会告诉你当前我的这个玩法，他们会巴拉巴拉一大堆<code>Bitmap.options</code> 参数怎么配置，先decode宽高，怎么内存复用，怎么节省内存，原理是什么巴拉巴拉一大堆。但是，终究你的大图操作还是Bitimap操作，还是免不了消耗几十兆内存，几十兆内存申请，你懂得。</p>
<p>国内99.9%的android程序员，你让他给你说出的最好的操作图片避免OOM的方法，回答都要经过bitmap，bitmap对于3000*4000分辨率的大图操作都没辙，很容易OOM。</p>
<p>当然有些人能告诉你会有绕过bitmap的方法，但是我负责任的说他们都不说不清楚具体怎么做，他们甚至不去了解目前linux，mac下常用的开源图片软件怎么实现的，包括不会去了解服务器上的图片操作库是怎么实现的，另外甚至想当然的以为可以做到零内存消耗，以为只操作文件即可，以为不用去解析jpeg编码中的<strong>色彩，RGB，YUV，变换算法，文件编码</strong>等信息。并不了解目前市面上开源的linux图片压缩库的算法都是什么。而实际上：图片操作需要很大内存开销，内存开销永远都绕不过去，CPU开销也是一直存在的。</p>
<p>我几年前听过的一个笑话，一个不懂计算机的人说windows下拿个记事本在那里敲1010101001，然后保存一下txt，重命名后缀名为exe就可以执行了，哈哈哈。妈的exe文件的头几个字节呢？</p>
<h2>做这个库的初心</h2>
<p>做各种项目总是遇到大图，三星手机相机拍摄的图片远大于3000*4000，又是在exif里做了旋转。所以这个问题很容易遇到各种问题，然后需求被卡死在这里。这里不说太多了，稍微有点经验的程序员都懂得。</p>
<p>再举例子：我们常见的情况手机里的照片12M这么大，需求上需要压缩图片质量，但不压缩尺寸上传，而你一旦压缩，质量不单很差，而且很容易内存爆了。3000×4000×4/1024/1024=45M 你想想这种情况的内存开销多大，除了这个图的内存消耗之外，其他地方也需要内存开销啊！这个45的申请，很容易导致OOM，而且当前的很多新机器拍摄出的图片比3000×4000还要大。</p>
<p>回过头来说下这个库的原理，我们都知道JVM xmx参数，这个xmx不做具体介绍，这是jvm的基本参数，不了解的请自行查询Java虚拟机原理。</p>
<p>android的Dalvik/ART遵守了JVM的规范，也有堆内存限制，遇到大图操作缩放旋转Bitmap的时候，就很容易OOM。</p>
<pre><code>注：

虽然，现在新的android系统提供的这个限制都在调大，我记得6.0官方ROM好像是96M,

非官方ROM要大一些，因为非官方ROM在编译时修改了xmx参数配置，但是新出的手机相机

拍摄出来的图片更大，相机技术的增长速度远大于这个限制的开放程度，进行大图操作
，你懂得。

</code></pre>
<p>目前在android系统源码对Bitmap的操作，是在native函数里面操作，但是内存申请是申请在Java heap。(国内有的人喜欢叫javaheap有的人喜欢叫dalvik heap)</p>
<p>证据见如下源码：</p>
<pre><code>
//老版本android源码：来自互联网 

jobjectGraphicsJNI::createBitmap(JNIEnv* env, SkBitmap* bitmap, jbyteArray buffer,  

                                  boolisMutable, jbyteArray ninepatch, int density)  

{  

    SkASSERT(bitmap);  

    SkASSERT(bitmap-&gt;pixelRef());  

    jobject obj = env-&gt;NewObject(gBitmap_class, gBitmap_constructorMethodID,  

           static_cast&lt;jint&gt;(reinterpret_cast&lt;uintptr_t&gt;(bitmap)),  

            buffer, isMutable, ninepatch,density);  

    hasException(env); // For the side effectof logging.  

    return obj;  

}  



//新版本android 6.0源码，来自我的电脑

//路径 aosp/downloadaosp/platform_frameworks_base/core/jni/android/graphics/Graphics.cpp

jobject GraphicsJNI::createBitmap(JNIEnv* env, android::Bitmap* bitmap,

        int bitmapCreateFlags, jbyteArray ninePatchChunk, jobject ninePatchInsets,

        int density) {

    bool isMutable = bitmapCreateFlags &amp; kBitmapCreateFlag_Mutable;

    bool isPremultiplied = bitmapCreateFlags &amp; kBitmapCreateFlag_Premultiplied;

    // The caller needs to have already set the alpha type properly, so the

    // native SkBitmap stays in sync with the Java Bitmap.

    assert_premultiplied(bitmap-&gt;info(), isPremultiplied);

    jobject obj = env-&gt;NewObject(gBitmap_class, gBitmap_constructorMethodID,

            reinterpret_cast&lt;jlong&gt;(bitmap), bitmap-&gt;javaByteArray(),

            bitmap-&gt;width(), bitmap-&gt;height(), density, isMutable, isPremultiplied,

            ninePatchChunk, ninePatchInsets);

    hasException(env); // For the side effect of logging.

    return obj;

}
</code></pre>
<p>上面说的核心原因在于你的bitmap内存申请都在java heap中，这个最大内存的限制。其实我们可以选择绕过这个heap操作图片。
native heap处于不太受管理的状态，这一点很多人不知道，这就是这个库比较有突破性的地方，native对于大部分android程序员来说，不了解，不熟悉，不写，不关心，呵呵呵呵呵呵呵。</p>
<p>在native中我们可以申请到硬件可提供的最大内存，而不会被虚拟机限制住size，当然你申请超过硬件的大小，比如2G，就会被系统给杀掉。</p>
<h2>证明native heap内存申请无限制</h2>
<p>我尝试用native写了个申请巨大内存又不执行free()的代码进行测试，申请了1.4G的内存还是不会OOM，下图是我用adb shell dumpsys meminfo PACKAGENAME打印出来的当前memory信息。</p>
<p><img src="assets/native_memory_show.png" alt=""/></p>
<h1></h1>
<p>于是我动手写了一个库，基于libjpeg-turbo，因为我是一个linux 用户，大部分电脑上的软件都是开源的，我都会去稍微了解一下 源码，所以很早就得知libjpeg，libpng目前业内大部分的图片操作软件几乎都是基于他们，包括谷歌年初开源的guetzli这个图片压缩库，年初这个库出1.0版本，我也有及时去跟进，把这个库导入到android平台了，当时是依赖于libjpeg不是libjpeg-turbo，guetzli这个库的压缩比清晰度不比tinypng差，而且压缩出来的文件大小更是比tinypng还要强，但是有个问题就是他太吃CPU，内存消耗的话还好，完全取决于图片尺寸，我觉得guetzli可能目前更适合服务器，tinypng的服务器代码的压缩性能估计也是跟他类似，都是压缩非常吃硬件，但是压缩的结果非常得小，而且保持了图片的高质量。
回到android平台，android系统开放给应用开发者的Bitmap的操作功能比如裁剪，缩放之类的，底层还是libjpeg，当然为了考虑压缩性能，没有让libjpeg的性能发挥出来，android并不是直接封装的libjpeg，而是基于了另一个叫Skia的开源项目来作为的图像处理引擎,这个引擎最大的特点就是基于比较高效低质的算法来实现，特别适用于性能差的机器。
所以，我们android直接通过bitmap调用底层的jni算法压缩出来的图片质量远差于其他任何一个图片的压缩库。包括不如IOS。</p>
<pre><code>乔布斯：啊哈哈哈哈哈哈！！
</code></pre>
<p>这个是在性能跟质量方面的取舍。性能这块我不再多说,参考:《简书：Android图片编码机制（Bitmap，Skia，libJpeg）
》</p>
<h2>回到这个库本身话题：</h2>
<p>这个库的核心价值在于绕过Java heap(有人喜欢叫叫Dalvik heap)的限制，去操作图片，保证无需担心OOM。
怎么绕过java heap呢？就是绕过bitmap,直接用native直接对图片进行操作，毕竟上面说了Android 2.3以后的机器bitmap内存都在Java Heap中,我们所有操作图片时的内存申请都在Native heap中。</p>
<p>这个库是基于libjpeg-turbo，说白了还是libjpeg，但是这个是没有牺牲CPU消耗，降低色彩质量的版本。你用这个库不管是compress，还是resize都能保证很好的色彩，android原生利用bitmap调用的那个libjpeg库，色彩太垃圾了，压缩我的自拍照感觉我脸上被抹屎了。</p>
<p>性能方面：我目前没有出专门用于arm64这个ABI的so文件，只是出个armv5的so文件，性能并没有发挥到极致，即使即使者这样子的情况，对3000×4000多尺寸的超大图操作，小米5的表现是3s多,完全可接受范围内，而且这3s多还有10M左右的文件读写时间在里面。毕竟迎来新时代，新契机，自然有新的硬件性能，可惜android底层源码还没有迎接“党的十九大指出的新时代”。动手撸了这个库，我新时代的社会主义接班人胸前的红领巾更加的鲜艳了呢。哈哈哈哈！！！</p>
<hr/>
<h2>好了解释到这里，代码在这里，快上车：</h2>
<p><a href="https://github.com/BruceWind/OperatingImageBypassDalvik">https://github.com/BruceWind/OperatingImageBypassDalvik</a></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"撸了一个库：绕过Java Heap操作图片，完全避免OOM","title":"撸了一个库：绕过Java Heap操作图片，完全避免OOM.md","mdsource":"md/撸了一个库：绕过Java Heap操作图片，完全避免OOM.md","date":" 2017/12/29 14:52:02","category":"开源"},"content":"title: 撸了一个库：绕过Java Heap操作图片，完全避免OOM\ndate: 2017/12/29 14:52:02\nupdated: 2018/04/24 17:58:55\ncategories:\n- 技术\n---\n\n首先，请专心阅读，因为：这个库不能算是技术性突破，但是对国内大部分android开发者而言，都是打破常规的新认识，这里我要吹个牛了。\n\n\n\n为什么这么说呢？你问你身边的同事，怎么操作图片避免OOM，都不会告诉你当前我的这个玩法，他们会巴拉巴拉一大堆`Bitmap.options` 参数怎么配置，先decode宽高，怎么内存复用，怎么节省内存，原理是什么巴拉巴拉一大堆。但是，终究你的大图操作还是Bitimap操作，还是免不了消耗几十兆内存，几十兆内存申请，你懂得。\n\n\n\n国内99.9%的android程序员，你让他给你说出的最好的操作图片避免OOM的方法，回答都要经过bitmap，bitmap对于3000*4000分辨率的大图操作都没辙，很容易OOM。\n\n \n当然有些人能告诉你会有绕过bitmap的方法，但是我负责任的说他们都不说不清楚具体怎么做，他们甚至不去了解目前linux，mac下常用的开源图片软件怎么实现的，包括不会去了解服务器上的图片操作库是怎么实现的，另外甚至想当然的以为可以做到零内存消耗，以为只操作文件即可，以为不用去解析jpeg编码中的**色彩，RGB，YUV，变换算法，文件编码**等信息。并不了解目前市面上开源的linux图片压缩库的算法都是什么。而实际上：图片操作需要很大内存开销，内存开销永远都绕不过去，CPU开销也是一直存在的。\n\n\n我几年前听过的一个笑话，一个不懂计算机的人说windows下拿个记事本在那里敲1010101001，然后保存一下txt，重命名后缀名为exe就可以执行了，哈哈哈。妈的exe文件的头几个字节呢？\n\n\n\n\n\n## 做这个库的初心\n\n做各种项目总是遇到大图，三星手机相机拍摄的图片远大于3000*4000，又是在exif里做了旋转。所以这个问题很容易遇到各种问题，然后需求被卡死在这里。这里不说太多了，稍微有点经验的程序员都懂得。\n\n再举例子：我们常见的情况手机里的照片12M这么大，需求上需要压缩图片质量，但不压缩尺寸上传，而你一旦压缩，质量不单很差，而且很容易内存爆了。3000×4000×4/1024/1024=45M 你想想这种情况的内存开销多大，除了这个图的内存消耗之外，其他地方也需要内存开销啊！这个45的申请，很容易导致OOM，而且当前的很多新机器拍摄出的图片比3000×4000还要大。\n\n\n回过头来说下这个库的原理，我们都知道JVM xmx参数，这个xmx不做具体介绍，这是jvm的基本参数，不了解的请自行查询Java虚拟机原理。\n\nandroid的Dalvik/ART遵守了JVM的规范，也有堆内存限制，遇到大图操作缩放旋转Bitmap的时候，就很容易OOM。\n\n```\n注：\n\n虽然，现在新的android系统提供的这个限制都在调大，我记得6.0官方ROM好像是96M,\n\n非官方ROM要大一些，因为非官方ROM在编译时修改了xmx参数配置，但是新出的手机相机\n\n拍摄出来的图片更大，相机技术的增长速度远大于这个限制的开放程度，进行大图操作\n，你懂得。\n\n```\n目前在android系统源码对Bitmap的操作，是在native函数里面操作，但是内存申请是申请在Java heap。(国内有的人喜欢叫javaheap有的人喜欢叫dalvik heap)\n\n证据见如下源码：\n\n```\n\n//老版本android源码：来自互联网 \n\njobjectGraphicsJNI::createBitmap(JNIEnv* env, SkBitmap* bitmap, jbyteArray buffer,  \n\n                                  boolisMutable, jbyteArray ninepatch, int density)  \n\n{  \n\n    SkASSERT(bitmap);  \n\n    SkASSERT(bitmap-\u003epixelRef());  \n\n    jobject obj = env-\u003eNewObject(gBitmap_class, gBitmap_constructorMethodID,  \n\n           static_cast\u003cjint\u003e(reinterpret_cast\u003cuintptr_t\u003e(bitmap)),  \n\n            buffer, isMutable, ninepatch,density);  \n\n    hasException(env); // For the side effectof logging.  \n\n    return obj;  \n\n}  \n\n\n\n//新版本android 6.0源码，来自我的电脑\n\n//路径 aosp/downloadaosp/platform_frameworks_base/core/jni/android/graphics/Graphics.cpp\n\njobject GraphicsJNI::createBitmap(JNIEnv* env, android::Bitmap* bitmap,\n\n        int bitmapCreateFlags, jbyteArray ninePatchChunk, jobject ninePatchInsets,\n\n        int density) {\n\n    bool isMutable = bitmapCreateFlags \u0026 kBitmapCreateFlag_Mutable;\n\n    bool isPremultiplied = bitmapCreateFlags \u0026 kBitmapCreateFlag_Premultiplied;\n\n    // The caller needs to have already set the alpha type properly, so the\n\n    // native SkBitmap stays in sync with the Java Bitmap.\n\n    assert_premultiplied(bitmap-\u003einfo(), isPremultiplied);\n\n    jobject obj = env-\u003eNewObject(gBitmap_class, gBitmap_constructorMethodID,\n\n            reinterpret_cast\u003cjlong\u003e(bitmap), bitmap-\u003ejavaByteArray(),\n\n            bitmap-\u003ewidth(), bitmap-\u003eheight(), density, isMutable, isPremultiplied,\n\n            ninePatchChunk, ninePatchInsets);\n\n    hasException(env); // For the side effect of logging.\n\n    return obj;\n\n}\n```\n\n上面说的核心原因在于你的bitmap内存申请都在java heap中，这个最大内存的限制。其实我们可以选择绕过这个heap操作图片。 \nnative heap处于不太受管理的状态，这一点很多人不知道，这就是这个库比较有突破性的地方，native对于大部分android程序员来说，不了解，不熟悉，不写，不关心，呵呵呵呵呵呵呵。\n\n在native中我们可以申请到硬件可提供的最大内存，而不会被虚拟机限制住size，当然你申请超过硬件的大小，比如2G，就会被系统给杀掉。\n\n## 证明native heap内存申请无限制\n我尝试用native写了个申请巨大内存又不执行free()的代码进行测试，申请了1.4G的内存还是不会OOM，下图是我用adb shell dumpsys meminfo PACKAGENAME打印出来的当前memory信息。\n\n\n![](assets/native_memory_show.png)\n\n# \n\n于是我动手写了一个库，基于libjpeg-turbo，因为我是一个linux 用户，大部分电脑上的软件都是开源的，我都会去稍微了解一下 源码，所以很早就得知libjpeg，libpng目前业内大部分的图片操作软件几乎都是基于他们，包括谷歌年初开源的guetzli这个图片压缩库，年初这个库出1.0版本，我也有及时去跟进，把这个库导入到android平台了，当时是依赖于libjpeg不是libjpeg-turbo，guetzli这个库的压缩比清晰度不比tinypng差，而且压缩出来的文件大小更是比tinypng还要强，但是有个问题就是他太吃CPU，内存消耗的话还好，完全取决于图片尺寸，我觉得guetzli可能目前更适合服务器，tinypng的服务器代码的压缩性能估计也是跟他类似，都是压缩非常吃硬件，但是压缩的结果非常得小，而且保持了图片的高质量。 \n回到android平台，android系统开放给应用开发者的Bitmap的操作功能比如裁剪，缩放之类的，底层还是libjpeg，当然为了考虑压缩性能，没有让libjpeg的性能发挥出来，android并不是直接封装的libjpeg，而是基于了另一个叫Skia的开源项目来作为的图像处理引擎,这个引擎最大的特点就是基于比较高效低质的算法来实现，特别适用于性能差的机器。 \n所以，我们android直接通过bitmap调用底层的jni算法压缩出来的图片质量远差于其他任何一个图片的压缩库。包括不如IOS。\n\n\n    乔布斯：啊哈哈哈哈哈哈！！\n\n这个是在性能跟质量方面的取舍。性能这块我不再多说,参考:《简书：Android图片编码机制（Bitmap，Skia，libJpeg） \n》\n\n## 回到这个库本身话题：\n这个库的核心价值在于绕过Java heap(有人喜欢叫叫Dalvik heap)的限制，去操作图片，保证无需担心OOM。 \n怎么绕过java heap呢？就是绕过bitmap,直接用native直接对图片进行操作，毕竟上面说了Android 2.3以后的机器bitmap内存都在Java Heap中,我们所有操作图片时的内存申请都在Native heap中。\n\n\n\n这个库是基于libjpeg-turbo，说白了还是libjpeg，但是这个是没有牺牲CPU消耗，降低色彩质量的版本。你用这个库不管是compress，还是resize都能保证很好的色彩，android原生利用bitmap调用的那个libjpeg库，色彩太垃圾了，压缩我的自拍照感觉我脸上被抹屎了。\n\n\n\n性能方面：我目前没有出专门用于arm64这个ABI的so文件，只是出个armv5的so文件，性能并没有发挥到极致，即使即使者这样子的情况，对3000×4000多尺寸的超大图操作，小米5的表现是3s多,完全可接受范围内，而且这3s多还有10M左右的文件读写时间在里面。毕竟迎来新时代，新契机，自然有新的硬件性能，可惜android底层源码还没有迎接“党的十九大指出的新时代”。动手撸了这个库，我新时代的社会主义接班人胸前的红领巾更加的鲜艳了呢。哈哈哈哈！！！\n\n-------------------\n## 好了解释到这里，代码在这里，快上车：\n[https://github.com/BruceWind/OperatingImageBypassDalvik](https://github.com/BruceWind/OperatingImageBypassDalvik)","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"撸了一个库：绕过Java Heap操作图片，完全避免OOM"},"buildId":"zaycUZ6jvMLykcBwRP9wT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>