<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>用NDK做了一个AES加密的库.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="用NDK做了一个AES加密的库.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="用NDK做了一个AES加密的库.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2016/12/04 23:16:33"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel 1k33q06 gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-1a3bc1a098c2d99b.js" defer=""></script><script src="/_next/static/chunks/771-6a778ea1fc3e748f.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-0f929ec094b5fc83.js" defer=""></script><script src="/_next/static/lw2IExpT7GBLnCqajAO6w/_buildManifest.js" defer=""></script><script src="/_next/static/lw2IExpT7GBLnCqajAO6w/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall mui-style-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">用NDK做了一个AES加密的库.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2016/12/04 23:16:33</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: 用NDK做了一个AES加密的库
date: 2016/12/04 23:16:33
updated: 2017/12/12 15:46:16
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>##用NDK做了一个AES加密的库，并且做了防止二次打包的校验</p>
<blockquote>
<p>真刀真枪派不太会写文章，你就听我简单的吹吹牛逼，最后看代码就好了。</p>
</blockquote>
<hr/>
<p>很多公司再客户端做的常见的两种加密方案：</p>
<blockquote>
<ul>
<li>在java代码里做加密算法</li>
<li>在native代码里做加密算法</li>
</ul>
</blockquote>
<p>上面两种加密。</p>
<p><strong>第一种</strong>，他们自己觉得就不够安全，java代码很容易被反编译得到，然后就在打包时用一个第三方的比如：360加固宝，来对dex文件进行加密。这样子代码相当于再混淆，几乎已经无法被看到了，但是不管怎样代码终究在那里，依然会整理出来。但是，目前加壳技术也被破解，搜索360加固脱壳。</p>
<p><strong>第二种</strong>，这种是常见的了，用native实现，很难看到代码。但是话说回来，jni接口是没有安全性可言的，如果app被反编译，别人只要知道so文件是怎么调用，不需要管你的native加密方式，打包直接调用jni即可，一样可以拿来破解。所以单纯native也是不行，此时你需要做一个签名的校验，防止二次打包。</p>
<h1></h1>
<p>这就是为什么去做这个开源项目的原因，别人反编译apk拿到了so文件，知道了jni接口怎么调用，即使你的java代码都给他看到了。但是，他只要再次打包，当调用native方法时，native就会先进行签名校验，判断是不是之前我生成的签名文件，如果不是，encode方法返回的就是一串乱码。</p>
<p>apk被二次打包，目前比较牛叉的hack也只能二次打包java文件，so文件的安全性要高很多，这样子的做伐既解决了加密算法代码裸露问题，也解决了被二次打包的问题，完美！！</p>
<p>(^__^)</p>
<h1></h1>
<p>apk安全领域，最难破解无非就是<strong>keystore</strong>文件，这也是BAT等一线大公司的商用SDK做校验时采用的做法，用判断当前包的keystore文件的<strong>hashcode或者SHA1值</strong>来判断。</p>
<h2>好了，废话说完了，放出github地址了</h2>
<p><a href="https://github.com/BruceWind/AESJniEncrypt">https://github.com/BruceWind/AESJniEncrypt</a></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> ndk实现AES加密</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用JniOnload 隐藏c函数</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 再做一层防止被二次打包的签名校验</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> key存在符号表中，同时隐藏字符表</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用obfuscator混淆C的代码</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/>  增加obfucator对x86的支持,具体配置obfucator的教程底部有链接。</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 手工处理隐藏key，最复杂的方案：将密钥分成不同的几段，存储在不同的代码中，最后将他们拼接起来，可以将整个操作写的很复杂，增加逆向难度。（目前代码里用的是稍微简单的方案）</li>
<li class="task-list-item"><input type="checkbox" disabled=""/> TODO：代码run的时候屏蔽模拟器</li>
<li class="task-list-item"><input type="checkbox" disabled=""/> TODO：防止so代码被code inject</li>
</ul>
<pre><code>char * key = &quot;NMTIzNDU2Nzg5MGFiY2RlZg&quot;;//这里是key被做过处理存储在这里的，实际上真实的key是：&quot;1234567890abcdef&quot;
</code></pre>
<h2>集成</h2>
<p>a.先配置local.properties中ndk.dir 要求使用ndk版本必须12b以上.</p>
<p>b.集成到项目中请修改类名方法名,不要暴露加密算法，自行修改key存储到代码里的方案.</p>
<p>c.生成和修改签名.</p>
<p><strong>c.1.生成</strong></p>
<pre><code>//再当前目录下
$ mkdir  keystore
$ cd keystore/
$ keytool -genkey -alias client1 -keypass 123456 -keyalg RSA -keysize 1024 -validity 365 -storetype PKCS12 -keystore ./androidyuan.keystore
输入密钥库口令:nickname
再次输入新口令:nickname
警告: PKCS12 密钥库不支持其他存储和密钥口令。正在忽略用户指定的-keypass值。
您的名字与姓氏是什么?
  [Unknown]:  nickname
您的组织单位名称是什么?
  [Unknown]:  androidyuan.com
您的组织名称是什么?
  [Unknown]:  androidyuan.com
您所在的城市或区域名称是什么?
  [Unknown]:  shanghai
您所在的省/市/自治区名称是什么?
  [Unknown]:  shanghai
该单位的双字母国家/地区代码是什么?
  [Unknown]:  cn
CN=nickname, OU=xxx.com, O=xxx.com, L=shanghai, ST=shanghai, C=cn是否正确?
  [否]:  y

//测试 keystore口令是否正确
$ keytool -exportcert -alias androiddebugkey -keystore   &quot;androidyuan.keystore&quot; | openssl sha1 -binary | openssl base64
  输入密钥库口令:  nickname
  8GUZG0hBFvUZ1I4kSq/3vowhE7Y=


</code></pre>
<p><strong>c.2.取得当前keystore的hash值,并修改native代码中的包名和hash</strong></p>
<pre><code>目前似乎没有好的办法，我只能用java取，**getSignature(Context context)**打log取出之后，然后写入到C文件中，重新build项目。
</code></pre>
<p>集成到自己项目中请先修改keystore hashcode和包名，防止反编译时拿到so文件，进行二次打包使用。</p>
<h2>鸣谢</h2>
<p>Base64 算法 来自：<a href="https://github.com/willemt/pearldb">https://github.com/willemt/pearldb</a></p>
<p>AES128 算法 来自：<a href="https://github.com/kokke/tiny-AES128-C">https://github.com/kokke/tiny-AES128-C</a></p>
<p>Native代码混淆器：<a href="https://fuzion24.github.io/android/obfuscation/ndk/llvm/o-llvm/2014/07/27/android-obfuscation-o-llvm-ndk">obfuscation-o-llvm-ndk</a></p>
<h3>注意 : SO会变大的问题</h3>
<p><img src="https://github.com/BruceWind/AESJniEncrypt/raw/master/img/unobfscator_debugapk.png" alt="未混淆的so"/>
<img src="https://github.com/BruceWind/AESJniEncrypt/raw/master/img/obfscator_screen.png" alt="已混淆的so"/></p>
<p>对比： 混淆后的so是混淆前的三倍大小。</p>
<h3>PS:</h3>
<p>因为需要做签名校验，所以无法提供jcenter依赖了，望见谅！！</p>
<p>不管代码安全性多高，我依旧反对key存到代码里。</p>
<p>想要编译出混淆过native代码的so需要修改aesjni/build.gradle文件中的externalNativeBuild，并配置NDK下的LLVM。</p>
<p>这是我的NDK配置混淆器教程：<a href="https://github.com/BruceWind/Obfuscator-LLVM-4.0-BUILD-NDK">Obfuscator-LLVM-4.0-BUILD-NDK</a></p>
<hr/>
<p>有问题及时提:<a href="https://github.com/BruceWind/AESJniEncrypt/issues/new">new issues</a></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"用NDK做了一个AES加密的库","title":"用NDK做了一个AES加密的库.md","mdsource":"md/用NDK做了一个AES加密的库.md","date":" 2016/12/04 23:16:33","category":"几年后回看会觉得写的太烂"},"content":"title: 用NDK做了一个AES加密的库\ndate: 2016/12/04 23:16:33\nupdated: 2017/12/12 15:46:16\ncategories:\n- 技术\n---\n##用NDK做了一个AES加密的库，并且做了防止二次打包的校验\n\n\u003e 真刀真枪派不太会写文章，你就听我简单的吹吹牛逼，最后看代码就好了。\n\n********************\n\n很多公司再客户端做的常见的两种加密方案：\n\u003e - 在java代码里做加密算法\n\u003e - 在native代码里做加密算法\n\n上面两种加密。\n\n**第一种**，他们自己觉得就不够安全，java代码很容易被反编译得到，然后就在打包时用一个第三方的比如：360加固宝，来对dex文件进行加密。这样子代码相当于再混淆，几乎已经无法被看到了，但是不管怎样代码终究在那里，依然会整理出来。但是，目前加壳技术也被破解，搜索360加固脱壳。\n\n**第二种**，这种是常见的了，用native实现，很难看到代码。但是话说回来，jni接口是没有安全性可言的，如果app被反编译，别人只要知道so文件是怎么调用，不需要管你的native加密方式，打包直接调用jni即可，一样可以拿来破解。所以单纯native也是不行，此时你需要做一个签名的校验，防止二次打包。\n# \n这就是为什么去做这个开源项目的原因，别人反编译apk拿到了so文件，知道了jni接口怎么调用，即使你的java代码都给他看到了。但是，他只要再次打包，当调用native方法时，native就会先进行签名校验，判断是不是之前我生成的签名文件，如果不是，encode方法返回的就是一串乱码。\n\napk被二次打包，目前比较牛叉的hack也只能二次打包java文件，so文件的安全性要高很多，这样子的做伐既解决了加密算法代码裸露问题，也解决了被二次打包的问题，完美！！\n\n(^__^)\n\n# \napk安全领域，最难破解无非就是**keystore**文件，这也是BAT等一线大公司的商用SDK做校验时采用的做法，用判断当前包的keystore文件的**hashcode或者SHA1值**来判断。\n\n\n## 好了，废话说完了，放出github地址了\n[https://github.com/BruceWind/AESJniEncrypt](https://github.com/BruceWind/AESJniEncrypt)\n\n\n- [x] ndk实现AES加密\n- [x] 使用JniOnload 隐藏c函数\n- [x] 再做一层防止被二次打包的签名校验\n- [x] key存在符号表中，同时隐藏字符表\n- [x] 使用obfuscator混淆C的代码\n- [x]  增加obfucator对x86的支持,具体配置obfucator的教程底部有链接。\n- [x] 手工处理隐藏key，最复杂的方案：将密钥分成不同的几段，存储在不同的代码中，最后将他们拼接起来，可以将整个操作写的很复杂，增加逆向难度。（目前代码里用的是稍微简单的方案）\n- [ ] TODO：代码run的时候屏蔽模拟器\n- [ ] TODO：防止so代码被code inject\n```\nchar * key = \"NMTIzNDU2Nzg5MGFiY2RlZg\";//这里是key被做过处理存储在这里的，实际上真实的key是：\"1234567890abcdef\"\n```\n## 集成\n\na.先配置local.properties中ndk.dir 要求使用ndk版本必须12b以上.\n\nb.集成到项目中请修改类名方法名,不要暴露加密算法，自行修改key存储到代码里的方案.\n\nc.生成和修改签名.\n\n**c.1.生成**\n```\n//再当前目录下\n$ mkdir  keystore\n$ cd keystore/\n$ keytool -genkey -alias client1 -keypass 123456 -keyalg RSA -keysize 1024 -validity 365 -storetype PKCS12 -keystore ./androidyuan.keystore\n输入密钥库口令:nickname\n再次输入新口令:nickname\n警告: PKCS12 密钥库不支持其他存储和密钥口令。正在忽略用户指定的-keypass值。\n您的名字与姓氏是什么?\n  [Unknown]:  nickname\n您的组织单位名称是什么?\n  [Unknown]:  androidyuan.com\n您的组织名称是什么?\n  [Unknown]:  androidyuan.com\n您所在的城市或区域名称是什么?\n  [Unknown]:  shanghai\n您所在的省/市/自治区名称是什么?\n  [Unknown]:  shanghai\n该单位的双字母国家/地区代码是什么?\n  [Unknown]:  cn\nCN=nickname, OU=xxx.com, O=xxx.com, L=shanghai, ST=shanghai, C=cn是否正确?\n  [否]:  y\n\n//测试 keystore口令是否正确\n$ keytool -exportcert -alias androiddebugkey -keystore   \"androidyuan.keystore\" | openssl sha1 -binary | openssl base64\n  输入密钥库口令:  nickname\n  8GUZG0hBFvUZ1I4kSq/3vowhE7Y=\n\n\n```\n\n**c.2.取得当前keystore的hash值,并修改native代码中的包名和hash**\n\n    目前似乎没有好的办法，我只能用java取，**getSignature(Context context)**打log取出之后，然后写入到C文件中，重新build项目。\n    \n  集成到自己项目中请先修改keystore hashcode和包名，防止反编译时拿到so文件，进行二次打包使用。\n## 鸣谢\n\nBase64 算法 来自：https://github.com/willemt/pearldb\n\nAES128 算法 来自：https://github.com/kokke/tiny-AES128-C\n\nNative代码混淆器：[obfuscation-o-llvm-ndk](https://fuzion24.github.io/android/obfuscation/ndk/llvm/o-llvm/2014/07/27/android-obfuscation-o-llvm-ndk)\n\n\n### 注意 : SO会变大的问题\n\n![未混淆的so](https://github.com/BruceWind/AESJniEncrypt/raw/master/img/unobfscator_debugapk.png)\n![已混淆的so](https://github.com/BruceWind/AESJniEncrypt/raw/master/img/obfscator_screen.png)\n\n对比： 混淆后的so是混淆前的三倍大小。\n\n### PS:\n因为需要做签名校验，所以无法提供jcenter依赖了，望见谅！！\n\n不管代码安全性多高，我依旧反对key存到代码里。\n\n\n想要编译出混淆过native代码的so需要修改aesjni/build.gradle文件中的externalNativeBuild，并配置NDK下的LLVM。\n\n这是我的NDK配置混淆器教程：[Obfuscator-LLVM-4.0-BUILD-NDK](https://github.com/BruceWind/Obfuscator-LLVM-4.0-BUILD-NDK)\n\n\n\n\n-------------------\n\n有问题及时提:[new issues](https://github.com/BruceWind/AESJniEncrypt/issues/new)","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"用NDK做了一个AES加密的库"},"buildId":"lw2IExpT7GBLnCqajAO6w","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>