<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>protobuf在android上的优化.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="protobuf在android上的优化.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="protobuf在android上的优化.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2017/03/29 10:34:58"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel vubbuv gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-beca72dadde25cc7.js" defer=""></script><script src="/_next/static/GHV3Hdifg6RQFG6pfrsvS/_buildManifest.js" defer=""></script><script src="/_next/static/GHV3Hdifg6RQFG6pfrsvS/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-style-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">protobuf在android上的优化.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2017/03/29 10:34:58</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: protobuf在android上的优化
date: 2017/03/29 10:34:58
updated: 2017/03/30 12:40:52
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<p>protobuf相信很多接触过socket的项目都用到过，消息推送，即时通讯，很多直播平台弹幕也是在使用protobuf。
json的诞生主要解决了xml时代的数据包过大的问题，json的解析性能也比XML稍微好那么一点。</p>
<p>但是，新时代的互联网流量，数据流量早已翻了一个数量级，json解析的性能和流量的耗费已经几乎无法满足人类的贪婪，所以为了全面实现小康社会，实现社会主义的伟大理想，protobuf诞生了，主要优化了json的包体过大和性能问题。</p>
<p>比如，一个两个字段的消息包：</p>
<pre><code>{
    key1:&quot;ha&quot;,
    key2:&quot;ha&quot;
}
</code></pre>
<p>包含两个字段的对象而已，在json上耗费需要21个字节。
换成PB之后，因为使用Varints序列化算法，第一个字符串长度为2，但是需要一个字节表示字段类型，一个字段类型表示字段标号，所以需要+2，后面一个字符串同理，两个字符串在一起就是8个字节。流量大大压缩，这也是很多公司选择PB的一个原因。</p>
<h1></h1>
<p>另外就是json的parse的过程耗时太久，android平台的DVM虚拟机不是基于栈而是基于寄存器，已经是很快的java虚拟机了，但是还是在遇到较大的json结构的时候，还是耗时在70-80ms左右的情况，Java方面的Json转化的过程是反射，虽然有fastjson这个库是一个不用反射做，而是操作字节码，但是fastjson在android平台也没有操作字节码，因为android的字节码比较特殊，dvm又不遵守JVM规范，不能完全拿JVM那一套来理解DVM的行为，所以android平台的json parse几乎都是反射作为parse的核心。
PB的序列化和反序列化因为算法较为简单，性能稍微好一些。</p>
<h1></h1>
<p>好了，废话说完了，那么本文的重点来了，json不好的点那么多，PB是不是缺点也很多呢？
android平台使用PB真恶心，proto协议文件转java，转出来非常大，proto文件里随便定义点东西，转出来就是1M+的代码量，2w行+的代码。</p>
<p>当然，proto文件中可以配置优化选项，选择优化codesize：</p>
<pre><code>option optimize_for = CODE_SIZE;
</code></pre>
<p>然后生成的java文件最小的配置，总大小是800KB多点,其实还是难以接受的。
但是,这样子性能不好，而且其实codesize也没有优化到我们觉得合适的大小。
proto还有个配置是：</p>
<pre><code>option optimize_for = SPEED;
</code></pre>
<p>这个代码执行性能最好，生成的代码量最大。</p>
<blockquote>
<p>还有个 LITE_RUNTIME:这个是上面两种兼得的方案，性能最好，生成的包也小，但是没有达到CODE_SIZE配置的小。</p>
</blockquote>
<p>android平台multidex的坑很多人都会遇到，方法数要超过65535，就会掉坑里，那么问题来了，PB这生成快1M的java代码不就是轻轻松松掉坑里嘛，对的！！！</p>
<p>所以，性能 和 文件大小二者不可得兼的情况下，导致android平台使用PB非常的坑爹。。。</p>
<p>开发者深感疲惫，java代码过多会带来很多问题，编译慢，app启动时，类的加载器进行类的加载的耗时也长，项目为了使用PB，开了Multidex之后，又需要填multidex的坑，总之各种烦。</p>
<h2>烦烦烦！！！</h2>
<h2>其他缺点</h2>
<p>代码太多的问题是个重头缺点，其他缺点，还有一些，proto文件转JAVA类使用的工具，也是麻烦，特么的真恶心，那个烂工具需要在电脑做一堆的配置才行，mac和windows用户都很麻烦，我的电脑是linux还好，因为开放的特性，apt仓库里已经加入了protobuf-compiler这个软件,这个时候linux的优点就提现出来了，直接命令行里输入protobuf，系统提示我没有这个命令，推荐我安装这个protobuf-compiler,我一个命令行，一分钟不到就安装好，之后就可以直接命令行转java了，linux开发还是方便很多，mac，windows就麻烦许多。
生成这么大的class文件我导入到AS中，AS会卡死很久，这个坑可是非常的大。因为代码太多，AS需要做一堆的检查，还有git比对，我靠，要死他妈的，卡几分钟有没有！！！！</p>
<p>所以，这个时候是不是有合适的优化方案去解决，size和 性能二者不可得兼的问题。</p>
<blockquote>
<p>你的代码只有不断优化，不断重构才能达到极致，公司必须给程序员更多的空余时间，程序员才有时间思考优化的方案，我喜欢这样的公司。</p>
</blockquote>
<h2>优化方案</h2>
<p>很不幸的是不知道国内用PB的都不去想办法优化还是怎么着，这方面的资料基本为0!!! 国外也是很少！！！</p>
<h3>Wire</h3>
<blockquote>
<p>其实，我翻阅了国外的很多杂七杂八的优化方案，发现这个还是最靠谱的。</p>
</blockquote>
<p>wire是square公司推出的一款优化proto在android平台的整套解决方案，包括生成java类，运行时优化，生成较小的java类同时又保证性能，这是一个不错的库。</p>
<p>解决的问题：
1.CODE文件过大；
2.性能不能最优；
3.生成新的class电脑需要配置；
4.AS因为Code过大会卡住；</p>
<h3>生成：</h3>
<p>proto 文件和compiler的jar包放在同一目录下，使用命令行</p>
<pre><code>java -jar ./wire-compiler-2.2.0-jar-with-dependencies.jar --proto_path=./ --java_out=gen/java/
</code></pre>
<p>因为是用java生成code，团队中每个开发电脑都肯定有JAVA环境的，所以是没有电脑需要配置的问题。生成出来会从1.2M降到280K,非常小，优化了快1M的大小,简直完美！！！</p>
<h3>使用：</h3>
<p>需要在gradle中集成runingtime依赖包，wire还会帮忙生成proto依赖的google的class，可以选择删除项目中原来以来的旧的proto的jar，导入生成好的几个class，可以帮忙节省一些打包出来的apk大小，如果项目从proto官方Message方案转到目前的wire方案，改动很小，wire为了保证迁移的成本，故意设计的更像官方的Message方案，我基本上1小时不到就迁移完毕了。</p>
<h3>wire缺点：</h3>
<p>这个库是在假设服务端返回字段都是健全的，不能缺少字段，它不会生成基础类型，都是装箱类型，说装箱很难理解，说简单点就是不用int，用Integer，因为不是基础类型，字段没赋值就会NULL异常，导致app崩溃，蛋疼的就在这里，这是一个非常蛋疼的点。</p>
<p>另外一个缺点就是proto文件中定义的enum的一些ID没有生成static final int的字段给我们使用，需要手动写常量，这个还是比较好处理的。</p>
<p>上面哪个null的问题，可比较难处理，这里需要去怼服务端，给老子正常的数据，虽然怼了，服务端承诺了不会再有这种情况，但是，老子信不过他。</p>
<p>人和人之间最基本的信任呢？？？？？what the fuck！</p>
<p>理解并重新编译wire-compiler库的源码？重新生成基础类？这个方案行不通，因为还要重新打包wire-runnigtime的代码，整个过程耗时可能不是一两天天的事情。我的选择我自己做了一个简单的类似JSON转化的组件，这个组件实现的功能是丢进来一个对象，我用反射去遍历所有的字段，然后对每个字段判空，给它设置一个默认值，int这种基础类型，你定义了一个字段，不设置值他的默认值是0，wire生成的Integer理应得到一个0的默认值，而不是NULL，所以解决方案就是这样子。
这个解决了就没有问题了，那么剩下的就是这个方案的实现。实现起来也是很麻烦的，涉及到一些Java特性的无法alloc的问题，处理起来也是比较棘手的，我是拿了Gson的源码中的两个类过来，因为之前项目里我做过这种东西，以前做过类似的JSON容错类，所以我把代码挪过来简单改下就直接用了。</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"protobuf在android上的优化","title":"protobuf在android上的优化.md","mdsource":"md/protobuf在android上的优化.md","date":" 2017/03/29 10:34:58","category":"几年后回看会觉得写的太烂"},"content":"title: protobuf在android上的优化\ndate: 2017/03/29 10:34:58\nupdated: 2017/03/30 12:40:52\ncategories:\n- 技术\n---\nprotobuf相信很多接触过socket的项目都用到过，消息推送，即时通讯，很多直播平台弹幕也是在使用protobuf。\njson的诞生主要解决了xml时代的数据包过大的问题，json的解析性能也比XML稍微好那么一点。\n\n但是，新时代的互联网流量，数据流量早已翻了一个数量级，json解析的性能和流量的耗费已经几乎无法满足人类的贪婪，所以为了全面实现小康社会，实现社会主义的伟大理想，protobuf诞生了，主要优化了json的包体过大和性能问题。\n\n比如，一个两个字段的消息包：\n```\n{\n    key1:\"ha\",\n    key2:\"ha\"\n}\n```\n包含两个字段的对象而已，在json上耗费需要21个字节。\n换成PB之后，因为使用Varints序列化算法，第一个字符串长度为2，但是需要一个字节表示字段类型，一个字段类型表示字段标号，所以需要+2，后面一个字符串同理，两个字符串在一起就是8个字节。流量大大压缩，这也是很多公司选择PB的一个原因。\n# \n另外就是json的parse的过程耗时太久，android平台的DVM虚拟机不是基于栈而是基于寄存器，已经是很快的java虚拟机了，但是还是在遇到较大的json结构的时候，还是耗时在70-80ms左右的情况，Java方面的Json转化的过程是反射，虽然有fastjson这个库是一个不用反射做，而是操作字节码，但是fastjson在android平台也没有操作字节码，因为android的字节码比较特殊，dvm又不遵守JVM规范，不能完全拿JVM那一套来理解DVM的行为，所以android平台的json parse几乎都是反射作为parse的核心。\nPB的序列化和反序列化因为算法较为简单，性能稍微好一些。\n# \n好了，废话说完了，那么本文的重点来了，json不好的点那么多，PB是不是缺点也很多呢？\nandroid平台使用PB真恶心，proto协议文件转java，转出来非常大，proto文件里随便定义点东西，转出来就是1M+的代码量，2w行+的代码。\n\n当然，proto文件中可以配置优化选项，选择优化codesize：\n```\noption optimize_for = CODE_SIZE;\n```\n然后生成的java文件最小的配置，总大小是800KB多点,其实还是难以接受的。\n但是,这样子性能不好，而且其实codesize也没有优化到我们觉得合适的大小。\nproto还有个配置是：\n```\noption optimize_for = SPEED;\n```\n这个代码执行性能最好，生成的代码量最大。\n\n\u003e 还有个 LITE_RUNTIME:这个是上面两种兼得的方案，性能最好，生成的包也小，但是没有达到CODE_SIZE配置的小。\n\nandroid平台multidex的坑很多人都会遇到，方法数要超过65535，就会掉坑里，那么问题来了，PB这生成快1M的java代码不就是轻轻松松掉坑里嘛，对的！！！\n\n\n所以，性能 和 文件大小二者不可得兼的情况下，导致android平台使用PB非常的坑爹。。。\n\n开发者深感疲惫，java代码过多会带来很多问题，编译慢，app启动时，类的加载器进行类的加载的耗时也长，项目为了使用PB，开了Multidex之后，又需要填multidex的坑，总之各种烦。\n## 烦烦烦！！！\n\n## 其他缺点\n代码太多的问题是个重头缺点，其他缺点，还有一些，proto文件转JAVA类使用的工具，也是麻烦，特么的真恶心，那个烂工具需要在电脑做一堆的配置才行，mac和windows用户都很麻烦，我的电脑是linux还好，因为开放的特性，apt仓库里已经加入了protobuf-compiler这个软件,这个时候linux的优点就提现出来了，直接命令行里输入protobuf，系统提示我没有这个命令，推荐我安装这个protobuf-compiler,我一个命令行，一分钟不到就安装好，之后就可以直接命令行转java了，linux开发还是方便很多，mac，windows就麻烦许多。\n生成这么大的class文件我导入到AS中，AS会卡死很久，这个坑可是非常的大。因为代码太多，AS需要做一堆的检查，还有git比对，我靠，要死他妈的，卡几分钟有没有！！！！\n\n所以，这个时候是不是有合适的优化方案去解决，size和 性能二者不可得兼的问题。\n\n\u003e  你的代码只有不断优化，不断重构才能达到极致，公司必须给程序员更多的空余时间，程序员才有时间思考优化的方案，我喜欢这样的公司。\n\n## 优化方案\n很不幸的是不知道国内用PB的都不去想办法优化还是怎么着，这方面的资料基本为0!!! 国外也是很少！！！\n\n### Wire\n\u003e 其实，我翻阅了国外的很多杂七杂八的优化方案，发现这个还是最靠谱的。\n\nwire是square公司推出的一款优化proto在android平台的整套解决方案，包括生成java类，运行时优化，生成较小的java类同时又保证性能，这是一个不错的库。\n\n解决的问题：\n1.CODE文件过大；\n2.性能不能最优；\n3.生成新的class电脑需要配置；\n4.AS因为Code过大会卡住；\n\n\n### 生成：\nproto 文件和compiler的jar包放在同一目录下，使用命令行\n```\njava -jar ./wire-compiler-2.2.0-jar-with-dependencies.jar --proto_path=./ --java_out=gen/java/\n```\n因为是用java生成code，团队中每个开发电脑都肯定有JAVA环境的，所以是没有电脑需要配置的问题。生成出来会从1.2M降到280K,非常小，优化了快1M的大小,简直完美！！！\n\n### 使用：\n需要在gradle中集成runingtime依赖包，wire还会帮忙生成proto依赖的google的class，可以选择删除项目中原来以来的旧的proto的jar，导入生成好的几个class，可以帮忙节省一些打包出来的apk大小，如果项目从proto官方Message方案转到目前的wire方案，改动很小，wire为了保证迁移的成本，故意设计的更像官方的Message方案，我基本上1小时不到就迁移完毕了。\n\n### wire缺点：\n这个库是在假设服务端返回字段都是健全的，不能缺少字段，它不会生成基础类型，都是装箱类型，说装箱很难理解，说简单点就是不用int，用Integer，因为不是基础类型，字段没赋值就会NULL异常，导致app崩溃，蛋疼的就在这里，这是一个非常蛋疼的点。\n\n另外一个缺点就是proto文件中定义的enum的一些ID没有生成static final int的字段给我们使用，需要手动写常量，这个还是比较好处理的。\n\n上面哪个null的问题，可比较难处理，这里需要去怼服务端，给老子正常的数据，虽然怼了，服务端承诺了不会再有这种情况，但是，老子信不过他。\n\n人和人之间最基本的信任呢？？？？？what the fuck！\n\n理解并重新编译wire-compiler库的源码？重新生成基础类？这个方案行不通，因为还要重新打包wire-runnigtime的代码，整个过程耗时可能不是一两天天的事情。我的选择我自己做了一个简单的类似JSON转化的组件，这个组件实现的功能是丢进来一个对象，我用反射去遍历所有的字段，然后对每个字段判空，给它设置一个默认值，int这种基础类型，你定义了一个字段，不设置值他的默认值是0，wire生成的Integer理应得到一个0的默认值，而不是NULL，所以解决方案就是这样子。\n这个解决了就没有问题了，那么剩下的就是这个方案的实现。实现起来也是很麻烦的，涉及到一些Java特性的无法alloc的问题，处理起来也是比较棘手的，我是拿了Gson的源码中的两个类过来，因为之前项目里我做过这种东西，以前做过类似的JSON容错类，所以我把代码挪过来简单改下就直接用了。\n\n\n\n\n\n","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"protobuf在android上的优化"},"buildId":"GHV3Hdifg6RQFG6pfrsvS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>