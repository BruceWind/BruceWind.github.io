<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>从TextView源码解析：“android开发中，文字的最难适配”.md<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="从TextView源码解析：“android开发中，文字的最难适配”.md - 几年后回看会觉得写的太烂"/><meta property="og:title" content="从TextView源码解析：“android开发中，文字的最难适配”.md"/><meta property="og:type" content="article"/><meta property="article:published_time" content=" 2015/10/19 08:08:05"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel 1k33q06 gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-c0566a06cafc2ea3.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_buildManifest.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall mui-style-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">从TextView源码解析：“android开发中，文字的最难适配”.md</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">几年后回看会觉得写的太烂<!-- --> | <!-- --> 2015/10/19 08:08:05</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p>title: 从TextView源码解析：“android开发中，文字的最难适配”
date: 2015/10/19 08:08:05
updated: 2016/01/15 16:32:54
categories:</p>
<ul>
<li>技术</li>
</ul>
<hr/>
<h3>关于android相同分辨率，相同尺寸的手机，配置了相同尺寸sp单位字体，结果大小却不同的问题。</h3>
<p>这个问题很难。其实android适配中有很多很多的难题，比如：定制ROM自己开发权限管理问题，官方没提供检测有没有被用户拒绝的方法，定制ROM都是自家开发的，又没给开发人员文档。</p>
<p>我们开发的时候，在AS开发的时候，使用预览窗口，预览了480<em>800，720</em>1280,1080*1920三种分辨率下的情况，一个向左靠拢 和 向右靠拢的两个TextView是否会因为两边文字过长而重叠。如图这种的。
<img src="assets/5638d7d338f41108d20001da.PNG" alt=""/>
这个图只是举个这种往两边靠的文字的布局而已。</p>
<h1></h1>
<p>预览的时候都是好的，在测试的时候，大部分手机也都是正常的。
但是，在天语手机上测试的时候，还是发生了重叠。
那个实际截图我就不截图了，具体描述下：产品定的左边的文字8个，右边的文字 是服务器获取的，这样子带来的问题，就是重叠了。</p>
<h1></h1>
<p>然后我发现小米设置界面里，有个字体大小的控制，看到这个设置界面我似乎也懂了。
来不及解释了上图：</p>
<p><img src="assets/5638d7d338f41108d20001d9.PNG" alt=""/></p>
<p>最小的效果
<img src="assets/5633972038f411091500040c.PNG" alt=""/></p>
<p>最大的效果</p>
<p><img src="assets/5633972038f411091500040a.PNG" alt=""/></p>
<p><strong>明显可以看出底部 按钮 “应用”两个字的明显前一个很小。</strong></p>
<h1></h1>
<p>我想起之前解析自定义控件的读取自定义属性dp单位值转px单位的时候，对那段代码的解析。</p>
<p>让我们从源码角度，去看下字体的大小 是受什么控制的。</p>
<h1></h1>
<p><strong>TextView.java</strong></p>
<pre><code class="language-java">    public TextView(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {
        this(context, attrs, defStyleAttr, 0);
    }
    ...

	 if (appearance != null) {
            int n = appearance.getIndexCount();
            for (int i = 0; i &lt; n; i++) {
                int attr = appearance.getIndex(i);

                switch (attr) {

                    ...
                    ...

		case com.android.internal.R.styleable.TextView_textSize:
                textSize = a.getDimensionPixelSize(attr, textSize);
                break; 
                ...
                ...

	}


</code></pre>
<p>看到这里，想起了我之前的那个文章 <a href="http://crm345.com/post/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6%E4%B8%ADgetDimension%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">自定义控件中getDimension方法源码解析</a>
这个方法最后指向了</p>
<h1></h1>
<p><strong>TypedArray.java</strong></p>
<pre><code class="language-java">    public int getDimensionPixelSize(@DimenRes int id) throws NotFoundException {
        synchronized (mAccessLock) {
            TypedValue value = mTmpValue;
            if (value == null) {
                mTmpValue = value = new TypedValue();
            }
            getValue(id, value, true);
            if (value.type == TypedValue.TYPE_DIMENSION) {
                return TypedValue.complexToDimensionPixelSize(
                        value.data, mMetrics);
            }
            throw new NotFoundException(
                    &quot;Resource ID #0x&quot; + Integer.toHexString(id) + &quot; type #0x&quot;
                    + Integer.toHexString(value.type) + &quot; is not valid&quot;);
        }
    }

</code></pre>
<p>TypedValue.complexToDimensionPixelSize这个方法就不说了 最后还是指向了applyDimension()	这个方法。</p>
<h1></h1>
<p><strong>TypedValue.java</strong></p>
<pre><code class="language-java">public static float applyDimension(int unit, float value,
                                       DisplayMetrics metrics)
    {
        switch (unit) {
        case COMPLEX_UNIT_PX:
            return value;
        case COMPLEX_UNIT_DIP:
            return value * metrics.density;
        case COMPLEX_UNIT_SP:
             return value * metrics.scaledDensity;*//这里是重点
        case COMPLEX_UNIT_PT:
            return value * metrics.xdpi * (1.0f/72);
        case COMPLEX_UNIT_IN:
            return value * metrics.xdpi;
        case COMPLEX_UNIT_MM:
            return value * metrics.xdpi * (1.0f/25.4f);
        }
        return 0;
    }

</code></pre>
<p><strong>scaledDensity</strong>这个字段是用于控制字体缩放比例的。</p>
<h1></h1>
<p>好了，那么我们来试着打印不同状态情况下的<em><strong>scaledDensity</strong></em>。</p>
<h1></h1>
<p>当我使用最大的字体的时候：</p>
<pre><code class="language-log">10-30 16:10:44.727  11175-11175/com.xxxxx.fireworks D/DDDDDD﹕ scaledDensity = 2.42
</code></pre>
<p>当我使用最小的字体的时候：</p>
<pre><code class="language-log">10-30 16:13:47.887  11175-11175/com.xxxxx.fireworks D/DDDDDD﹕ scaledDensity = 1.72

</code></pre>
<p>好了最后就是这里了，不得不提到一个方法<strong>Resources.getSystem().getDisplayMetrics()<strong>这句可以获得DisplayMetrics。这里的含义已经很清晰，获得系统配置的</strong>DisplayMetrics</strong>。</p>
<h1></h1>
<p>那么，Resources.getSystem().**getDisplayMetrics()**这个方法里面做了什么?
好吧！我们继续从这个继续找源代码。</p>
<p><strong>Resources.java</strong></p>
<pre><code class="language-java">    public static Resources getSystem() {
        synchronized (sSync) {
            Resources ret = mSystem;
            if (ret == null) {
                ret = new Resources();
                mSystem = ret;
            }

            return ret;
        }
    }
    ...
    ...
  private Resources() {
        mAssets = AssetManager.getSystem();
        mConfiguration.setToDefaults();
        mMetrics.setToDefaults();//重点在于这一句
        updateConfiguration(null, null);
        mAssets.ensureStringBlocks();
    }


</code></pre>
<p>下面看下**setToDefaults()**这个方法：</p>
<p><strong>DisplayMetrics.java</strong></p>
<pre><code class="language-java">
 @Deprecated
    public static int DENSITY_DEVICE = getDeviceDensity();
...
...

 public void setToDefaults() {
        widthPixels = 0;
        heightPixels = 0;
        density =  DENSITY_DEVICE / (float) DENSITY_DEFAULT;
        densityDpi =  DENSITY_DEVICE;
        scaledDensity = density;
        xdpi = DENSITY_DEVICE;
        ydpi = DENSITY_DEVICE;
        noncompatWidthPixels = widthPixels;
        noncompatHeightPixels = heightPixels;
        noncompatDensity = density;
        noncompatDensityDpi = densityDpi;
        noncompatScaledDensity = scaledDensity;
        noncompatXdpi = xdpi;
        noncompatYdpi = ydpi;
    }
</code></pre>
<p>scaledDensity是DENSITY_DEVICE和DENSITY_DEFAULT除法计算的结果。
这个是android官方提供的frameworks_base中的源代码。</p>
<h1></h1>
<p>但是，实际开发中我<strong>只能打印出来DENSITY_DEFAULT，无法打印出来DENSITY_DEVICE，getDeviceDensity()这个方法也被隐藏了</strong>。</p>
<h1></h1>
<p>getDeviceDensity()方法里面的注释是：</p>
<pre><code>qemu.sf.lcd_density 可用于重写 ro.sf.lcd_density
当在真机上运行，允许动态配置。
这是由于该 ro.sf.lcd_density 
当它解析 build.prop 之前时，由 init 进程设置
</code></pre>
<h2>结论：</h2>
<p>那么，所以我们可以得出定制ROM字体大小不同，主要是因为定制ROM修改了getDeviceDensity()方法，使DENSITY_DEVICE的和<strong>scaledDensity的值在厂商的控制之内</strong>，这就是为什么，<strong>我们配置了字体大小的单位，在不同的机器上看起来还是有的很大，有的很小了</strong>。
开发过程中，即时预览的时候我们是按照官方ROM的结果预览，但每个厂商定制化严重，所以最终适配的效果就会很差劲。以前我SONY L36 官方ROM看字体都挺好，但是我刷了个Flyme，在魅族官网下载的，是官方的东西，结果刷完了，安装自己的app发现字体都变得好小，其实就是ROM定制化的原因。</p>
<h1></h1>
<p>PS：补充一点，setToDefaults()这个方法似乎也被小米的ROM团队修改了，因为按照常理，就算修改getDeviceDensity()，density应该与scaledDensity等值的，但是实际打印Log的过程中发现不是的，所以setToDefaults()这个方法也被厂商修改了。
所以小米这个修改字体的模式，是修改了setToDefaults()，而其他厂商可能仅仅只是修改了getDeviceDensity()。</p>
<p>PS：再再补充一点，MOTO G也可以修改字体大小。而其他一些机器就很少有可以修改字体大小的设置了。</p>
<h1></h1>
<p>本文涉及到 的github源码：</p>
<blockquote>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/Resources.java">https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/Resources.java</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/TypedValue.java">https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/TypedValue.java</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/widget/TextView.java">https://github.com/android/platform_frameworks_base/blob/master/core/java/android/widget/TextView.java</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/DisplayMetrics.java">https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/DisplayMetrics.java</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><a href="https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/TypedArray.java">https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/TypedArray.java</a></li>
</ul>
</blockquote></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"从TextView源码解析：“android开发中，文字的最难适配”","title":"从TextView源码解析：“android开发中，文字的最难适配”.md","mdsource":"md/从TextView源码解析：“android开发中，文字的最难适配”.md","date":" 2015/10/19 08:08:05","category":"几年后回看会觉得写的太烂"},"content":"title: 从TextView源码解析：“android开发中，文字的最难适配”\ndate: 2015/10/19 08:08:05\nupdated: 2016/01/15 16:32:54\ncategories:\n- 技术\n---\n### 关于android相同分辨率，相同尺寸的手机，配置了相同尺寸sp单位字体，结果大小却不同的问题。\n\n这个问题很难。其实android适配中有很多很多的难题，比如：定制ROM自己开发权限管理问题，官方没提供检测有没有被用户拒绝的方法，定制ROM都是自家开发的，又没给开发人员文档。\n\n我们开发的时候，在AS开发的时候，使用预览窗口，预览了480*800，720*1280,1080*1920三种分辨率下的情况，一个向左靠拢 和 向右靠拢的两个TextView是否会因为两边文字过长而重叠。如图这种的。\n![](assets/5638d7d338f41108d20001da.PNG)\n这个图只是举个这种往两边靠的文字的布局而已。\n# \n预览的时候都是好的，在测试的时候，大部分手机也都是正常的。\n但是，在天语手机上测试的时候，还是发生了重叠。\n那个实际截图我就不截图了，具体描述下：产品定的左边的文字8个，右边的文字 是服务器获取的，这样子带来的问题，就是重叠了。\n\n# \n然后我发现小米设置界面里，有个字体大小的控制，看到这个设置界面我似乎也懂了。 \n来不及解释了上图：\n\n\n![](assets/5638d7d338f41108d20001d9.PNG)\n\n最小的效果\n![](assets/5633972038f411091500040c.PNG)\n\n最大的效果\n\n![](assets/5633972038f411091500040a.PNG)\n\n**明显可以看出底部 按钮 “应用”两个字的明显前一个很小。**\n\n# \n我想起之前解析自定义控件的读取自定义属性dp单位值转px单位的时候，对那段代码的解析。\n\n让我们从源码角度，去看下字体的大小 是受什么控制的。\n# \n**TextView.java**\n``` java \n    public TextView(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {\n        this(context, attrs, defStyleAttr, 0);\n    }\n    ...\n\n\t if (appearance != null) {\n            int n = appearance.getIndexCount();\n            for (int i = 0; i \u003c n; i++) {\n                int attr = appearance.getIndex(i);\n\n                switch (attr) {\n\n                    ...\n                    ...\n\n\t\tcase com.android.internal.R.styleable.TextView_textSize:\n                textSize = a.getDimensionPixelSize(attr, textSize);\n                break; \n                ...\n                ...\n\n\t}\n\n\n``` \n\n看到这里，想起了我之前的那个文章 [自定义控件中getDimension方法源码解析](http://crm345.com/post/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6%E4%B8%ADgetDimension%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90)\n这个方法最后指向了  \n# \n**TypedArray.java**\n\n``` java\n    public int getDimensionPixelSize(@DimenRes int id) throws NotFoundException {\n        synchronized (mAccessLock) {\n            TypedValue value = mTmpValue;\n            if (value == null) {\n                mTmpValue = value = new TypedValue();\n            }\n            getValue(id, value, true);\n            if (value.type == TypedValue.TYPE_DIMENSION) {\n                return TypedValue.complexToDimensionPixelSize(\n                        value.data, mMetrics);\n            }\n            throw new NotFoundException(\n                    \"Resource ID #0x\" + Integer.toHexString(id) + \" type #0x\"\n                    + Integer.toHexString(value.type) + \" is not valid\");\n        }\n    }\n\n```\n\nTypedValue.complexToDimensionPixelSize这个方法就不说了 最后还是指向了applyDimension()\t这个方法。\n# \n**TypedValue.java**\n``` java\npublic static float applyDimension(int unit, float value,\n                                       DisplayMetrics metrics)\n    {\n        switch (unit) {\n        case COMPLEX_UNIT_PX:\n            return value;\n        case COMPLEX_UNIT_DIP:\n            return value * metrics.density;\n        case COMPLEX_UNIT_SP:\n             return value * metrics.scaledDensity;*//这里是重点\n        case COMPLEX_UNIT_PT:\n            return value * metrics.xdpi * (1.0f/72);\n        case COMPLEX_UNIT_IN:\n            return value * metrics.xdpi;\n        case COMPLEX_UNIT_MM:\n            return value * metrics.xdpi * (1.0f/25.4f);\n        }\n        return 0;\n    }\n\n```\n**scaledDensity**这个字段是用于控制字体缩放比例的。\n# \n好了，那么我们来试着打印不同状态情况下的***scaledDensity***。\n\n# \n\n当我使用最大的字体的时候：\n``` log\n10-30 16:10:44.727  11175-11175/com.xxxxx.fireworks D/DDDDDD﹕ scaledDensity = 2.42\n```\n当我使用最小的字体的时候：\n``` log\n10-30 16:13:47.887  11175-11175/com.xxxxx.fireworks D/DDDDDD﹕ scaledDensity = 1.72\n\n```\n\n好了最后就是这里了，不得不提到一个方法**Resources.getSystem().getDisplayMetrics()**这句可以获得DisplayMetrics。这里的含义已经很清晰，获得系统配置的**DisplayMetrics**。\n# \n那么，Resources.getSystem().**getDisplayMetrics()**这个方法里面做了什么?\n好吧！我们继续从这个继续找源代码。\n\n**Resources.java**\n``` java\n    public static Resources getSystem() {\n        synchronized (sSync) {\n            Resources ret = mSystem;\n            if (ret == null) {\n                ret = new Resources();\n                mSystem = ret;\n            }\n\n            return ret;\n        }\n    }\n    ...\n    ...\n  private Resources() {\n        mAssets = AssetManager.getSystem();\n        mConfiguration.setToDefaults();\n        mMetrics.setToDefaults();//重点在于这一句\n        updateConfiguration(null, null);\n        mAssets.ensureStringBlocks();\n    }\n\n\n```\n下面看下**setToDefaults()**这个方法：\n\n**DisplayMetrics.java**\n``` java\n\n @Deprecated\n    public static int DENSITY_DEVICE = getDeviceDensity();\n...\n...\n\n public void setToDefaults() {\n        widthPixels = 0;\n        heightPixels = 0;\n        density =  DENSITY_DEVICE / (float) DENSITY_DEFAULT;\n        densityDpi =  DENSITY_DEVICE;\n        scaledDensity = density;\n        xdpi = DENSITY_DEVICE;\n        ydpi = DENSITY_DEVICE;\n        noncompatWidthPixels = widthPixels;\n        noncompatHeightPixels = heightPixels;\n        noncompatDensity = density;\n        noncompatDensityDpi = densityDpi;\n        noncompatScaledDensity = scaledDensity;\n        noncompatXdpi = xdpi;\n        noncompatYdpi = ydpi;\n    }\n```\nscaledDensity是DENSITY_DEVICE和DENSITY_DEFAULT除法计算的结果。\n这个是android官方提供的frameworks_base中的源代码。\n# \n但是，实际开发中我**只能打印出来DENSITY_DEFAULT，无法打印出来DENSITY_DEVICE，getDeviceDensity()这个方法也被隐藏了**。\n\n# \ngetDeviceDensity()方法里面的注释是：\n\n\tqemu.sf.lcd_density 可用于重写 ro.sf.lcd_density\n\t当在真机上运行，允许动态配置。\n\t这是由于该 ro.sf.lcd_density \n\t当它解析 build.prop 之前时，由 init 进程设置\n\n## 结论：\n那么，所以我们可以得出定制ROM字体大小不同，主要是因为定制ROM修改了getDeviceDensity()方法，使DENSITY_DEVICE的和**scaledDensity的值在厂商的控制之内**，这就是为什么，**我们配置了字体大小的单位，在不同的机器上看起来还是有的很大，有的很小了**。\n开发过程中，即时预览的时候我们是按照官方ROM的结果预览，但每个厂商定制化严重，所以最终适配的效果就会很差劲。以前我SONY L36 官方ROM看字体都挺好，但是我刷了个Flyme，在魅族官网下载的，是官方的东西，结果刷完了，安装自己的app发现字体都变得好小，其实就是ROM定制化的原因。\n# \nPS：补充一点，setToDefaults()这个方法似乎也被小米的ROM团队修改了，因为按照常理，就算修改getDeviceDensity()，density应该与scaledDensity等值的，但是实际打印Log的过程中发现不是的，所以setToDefaults()这个方法也被厂商修改了。\n所以小米这个修改字体的模式，是修改了setToDefaults()，而其他厂商可能仅仅只是修改了getDeviceDensity()。\n\n\nPS：再再补充一点，MOTO G也可以修改字体大小。而其他一些机器就很少有可以修改字体大小的设置了。\n\n#  \n本文涉及到 的github源码：\n\n\u003e - https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/Resources.java\n\n\n\u003e -  https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/TypedValue.java\n\n\u003e - https://github.com/android/platform_frameworks_base/blob/master/core/java/android/widget/TextView.java\n\n\u003e - https://github.com/android/platform_frameworks_base/blob/master/core/java/android/util/DisplayMetrics.java\n\n\u003e - https://github.com/android/platform_frameworks_base/blob/master/core/java/android/content/res/TypedArray.java","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"从TextView源码解析：“android开发中，文字的最难适配”"},"buildId":"pUDExLTnYM1HHfZLuoalS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>