<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1, width=device-width"/><meta name="emotion-insertion-point" content=""/><title>Reach high security in Android<!-- --> - BruceWind&#x27;s Blog</title><meta name="description" content="Reach high security in Android - 开源"/><meta property="og:title" content="Reach high security in Android"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2016-11-29"/><meta name="next-head-count" content="8"/><meta charSet="utf-8"/><meta name="keywords" content="NDK,JNI,Android Dev,android,androidyuan,性能优化,Linux,developer"/><meta name="description" content="BruceWind&#x27;s personal blog - Android development, Linux, and more."/><meta name="robots" content="index,follow"/><meta name="google" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="author" content="bruce"/><link rel="icon" href="/favicon.ico"/><meta name="theme-color" content="#000000"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LGE1LT9YJG"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-LGE1LT9YJG');
              </script><style data-emotion="mui-style-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="mui-style 17ro72p 1cp6o32 79elbk 1qo0fs4 1uf4bbi 1m9pwf3 19gndve 1ju1kxc k1u9gz 6xugel 1k33q06 gtvj52 1x1vlev vax71z">.mui-style-17ro72p{width:100%;min-height:100vh;background-color:#fff;padding:16px;}.mui-style-1cp6o32{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);padding:24px;}.mui-style-79elbk{position:relative;}.mui-style-1qo0fs4{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;width:58px;height:38px;overflow:hidden;padding:12px;box-sizing:border-box;position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;z-index:0;vertical-align:middle;width:62px;height:34px;padding:7px;margin:8px;}@media print{.mui-style-1qo0fs4{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1qo0fs4 .MuiSwitch-switchBase{margin:1px;padding:0;-webkit-transform:translateX(6px);-moz-transform:translateX(6px);-ms-transform:translateX(6px);transform:translateX(6px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked{color:#fff;-webkit-transform:translateX(22px);-moz-transform:translateX(22px);-ms-transform:translateX(22px);transform:translateX(22px);}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked .MuiSwitch-thumb:before{background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g><path d="M0 0h24v24H0z" fill="none"/><path fill="white" d="M12 19a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm-5.5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zm11 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3zM13 2v2h6v2h-1.968a18.222 18.222 0 0 1-3.621 6.302 14.685 14.685 0 0 0 5.327 3.042l-.536 1.93A16.685 16.685 0 0 1 12 13.726a16.696 16.696 0 0 1-6.202 3.547l-.536-1.929a14.7 14.7 0 0 0 5.327-3.042 18.077 18.077 0 0 1-2.822-4.3h2.24A16.031 16.031 0 0 0 12 10.876a16.168 16.168 0 0 0 2.91-4.876L5 6V4h6V2h2z"/></g></svg>');}.mui-style-1qo0fs4 .MuiSwitch-switchBase.Mui-checked+.MuiSwitch-track{opacity:1;background-color:#aab4be;}.mui-style-1qo0fs4 .MuiSwitch-thumb{background-color:#001e3c;width:32px;height:32px;}.mui-style-1qo0fs4 .MuiSwitch-thumb:before{content:'';position:absolute;width:100%;height:100%;left:0;top:0;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;background-image:url('data:image/svg+xml;utf8,<?xml version="1.0" ?><svg height="20" width="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" /><path fill="white" d="M14 10h2v.757a4.5 4.5 0 0 1 7 3.743V20h-2v-5.5c0-1.43-1.175-2.5-2.5-2.5S16 13.07 16 14.5V20h-2V10zm-2-6v2H4v5h8v2H4v5h8v2H2V4h10z"/></svg>');}.mui-style-1qo0fs4 .MuiSwitch-track{opacity:1;background-color:#aab4be;border-radius:10px;}.mui-style-1uf4bbi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:9px;border-radius:50%;position:absolute;top:0;left:0;z-index:1;color:#fff;-webkit-transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,-webkit-transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:left 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,transform 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.mui-style-1uf4bbi::-moz-focus-inner{border-style:none;}.mui-style-1uf4bbi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-1uf4bbi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-1uf4bbi.Mui-checked{-webkit-transform:translateX(20px);-moz-transform:translateX(20px);-ms-transform:translateX(20px);transform:translateX(20px);}.mui-style-1uf4bbi.Mui-disabled{color:#f5f5f5;}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{opacity:0.5;}.mui-style-1uf4bbi.Mui-disabled+.MuiSwitch-track{opacity:0.12;}.mui-style-1uf4bbi .MuiSwitch-input{left:-100%;width:300%;}.mui-style-1uf4bbi:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.mui-style-1uf4bbi:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked{color:#1976d2;}.mui-style-1uf4bbi.Mui-checked:hover{background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-1uf4bbi.Mui-checked:hover{background-color:transparent;}}.mui-style-1uf4bbi.Mui-checked.Mui-disabled{color:rgb(167, 202, 237);}.mui-style-1uf4bbi.Mui-checked+.MuiSwitch-track{background-color:#1976d2;}.mui-style-1m9pwf3{cursor:inherit;position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;margin:0;padding:0;z-index:1;}.mui-style-19gndve{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);background-color:currentColor;width:20px;height:20px;border-radius:50%;}.mui-style-1ju1kxc{height:100%;width:100%;border-radius:7px;z-index:-1;-webkit-transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;background-color:#000;opacity:0.38;}.mui-style-k1u9gz{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;margin-bottom:16px;}.mui-style-k1u9gz::-moz-focus-inner{border-style:none;}.mui-style-k1u9gz.Mui-disabled{pointer-events:none;cursor:default;}@media print{.mui-style-k1u9gz{-webkit-print-color-adjust:exact;color-adjust:exact;}}.mui-style-k1u9gz:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.mui-style-k1u9gz:hover{background-color:transparent;}}.mui-style-k1u9gz.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.mui-style-6xugel{display:inherit;margin-right:8px;margin-left:-4px;}.mui-style-6xugel>*:nth-of-type(1){font-size:20px;}.mui-style-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.mui-style-gtvj52{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;margin-bottom:0.35em;}.mui-style-1x1vlev{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;margin-bottom:0.35em;color:rgba(0, 0, 0, 0.6);}.mui-style-vax71z{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><link rel="preload" href="/_next/static/css/345ff263c1768dbb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/345ff263c1768dbb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ef43a8d4a395f49.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-5b2299ded1a46c83.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4f0aaa3a6ba99024.js" defer=""></script><script src="/_next/static/chunks/34-75ae01f5fa578a9a.js" defer=""></script><script src="/_next/static/chunks/995-a5f98cc3a4d14286.js" defer=""></script><script src="/_next/static/chunks/771-702e6dcd51d5534b.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/blog/%5Bslug%5D-c0566a06cafc2ea3.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_buildManifest.js" defer=""></script><script src="/_next/static/pUDExLTnYM1HHfZLuoalS/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="MuiBox-root mui-style-17ro72p"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation3 mui-style-1cp6o32"><div class="MuiBox-root mui-style-79elbk"><div style="position:fixed;top:22px;right:15px;z-index:1300"><span class="MuiSwitch-root MuiSwitch-sizeMedium mui-style-1qo0fs4"><span class="MuiButtonBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked PrivateSwitchBase-root MuiSwitch-switchBase MuiSwitch-colorPrimary Mui-checked Mui-checked mui-style-1uf4bbi"><input class="PrivateSwitchBase-input MuiSwitch-input mui-style-1m9pwf3" type="checkbox" checked=""/><span class="MuiSwitch-thumb mui-style-19gndve"></span></span><span class="MuiSwitch-track mui-style-1ju1kxc"></span></span></div><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorPrimary mui-style-k1u9gz" tabindex="0" href="/cn/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium mui-style-6xugel"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall mui-style-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ArrowBackIcon"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"></path></svg></span>返回列表</a><h1 class="MuiTypography-root MuiTypography-h4 MuiTypography-gutterBottom mui-style-gtvj52">Reach high security in Android</h1><p class="MuiTypography-root MuiTypography-body2 MuiTypography-gutterBottom mui-style-1x1vlev">开源<!-- --> | <!-- -->2016-11-29</p><hr class="MuiDivider-root MuiDivider-fullWidth mui-style-vax71z"/><div class="markdown-body"><p><a href="https://github.com/BruceWind/AESJniEncrypt/blob/master/README.md">English</a></p>
<p><a href="https://github.com/BruceWind/AESJniEncrypt/blob/master/README_zh.md">中文</a></p>
<h1>追求极致的代码安全性保障</h1>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> <del>ndk实现AES加密</del>,性能不佳,已废弃此方式, 如果您仍旧需要该算法，check out tag: <a href="https://github.com/BruceWind/AESJniEncrypt/releases/tag/v2.2">v2.2</a>.</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用<strong>CHACHA20</strong>加密,TLS1.3也在移动端用了<strong>CHACHA20</strong>了,性能对ARM架构CPU更好。</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用JniOnload 隐藏C函数</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用签名校验避免被再次打包（这是绕过破解加密算法直接调用你的jni函数）</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> <del>key存在符号表中,同时隐藏字符表</del> 该方案已经废弃,<a href="https://github.com/weizongwei5/AESJniEncrypt/issues/5">废弃原因issues5</a></li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 手工处理隐藏key,最复杂的方案：将密钥分成不同的几段,存储在不同的代码中,最后将他们拼接起来,可以将整个操作写的很复杂,增加逆向难度。（目前代码里用的是稍微简单的方案）</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 使用obfuscator扰乱C的代码,<a href="https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html">关于破解obfuscator</a></li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/>  增加obfucator对x86的支持,具体配置obfucator的教程底部有链接。</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 反动态调试 , 目前代码里是比较简单的方案, 有更复杂更高明的方案,比如：每次执行加密解密签先去判断是否被trace,想要更复杂的自己fork之后去写</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""/> 代码运行时屏蔽模拟器 :代码来自我的另外一个仓库<a href="https://github.com/Scavenges/Check_Emulator_In_NDK">Check_Emulator_In_NDK</a></li>
<li class="task-list-item"><input type="checkbox" disabled=""/> TODO：防止so代码被code inject</li>
</ul>
<h2>尝试编译，并跑起来</h2>
<details>
<summary>click to open</summary>
1.准备：
<p>运行这个shell :</p>
<p><code>./build_libsodium_for_all_android_abi.sh</code>
当你初次运行该脚本, 一些错误你可能会看到:</p>
<pre><code>env: python: No such file or directory
...
See &quot;config.log&quot; for more details or others.
</code></pre>
<p>这些都是一些基础依赖需要安装到电脑，您可以尝试复制该错误信息，进行Google搜索。</p>
<p>2.打开AS运行app，从adb/AS里看日志。</p>
</details>
<h2>集成</h2>
<details>
<summary>click to open</summary>
a.先配置local.properties中ndk.dir 要求使用ndk版本必须11-13b,新版本ndk没有测试过,或许不能编译通过。
<p>b.集成到项目中请修改类名方法名,不要暴露加密算法,自行修改key存储到代码里的方案.</p>
<p>b.1. 生成 chacha20 key:</p>
<p>run <code>test_in_exexutaing.sh</code>,然后请看logcat. 我用C语言随机生成的key &amp; nonce会显示出来. 你需要粘贴到 <strong>JNIEntry.c</strong>.</p>
<p>c.生成和修改签名.</p>
<p><strong>c.1.生成keystore</strong></p>
<pre><code class="language-shell"># my generate record:
mkdir keystore
cd keystore/
keytool -genkey -alias client1 -keypass 123456 -keyalg RSA -keysize 1024 -validity 365 -storetype PKCS12 -keystore ./androidyuan.keystore
</code></pre>
<p><strong>c.2.用java取得当前keystore的hash值,并修改native代码中的包名和hash</strong></p>
<pre><code>用[getSignature()](https://github.com/BruceWind/AESJniEncrypt/blob/519a4f16ee0a61b05f8dd41419e3fe61836ee5c7/aesjni/src/main/java/com/androidyuan/aesjni/SignatureTool.java#L26)打log取出之后,然后写入到C文件中,重新build项目。
</code></pre>
<p>集成到自己项目中请先修改<code>check_signature.h</code>中的keystore hashcode和包名。</p>
</details>
<h2>鸣谢</h2>
<ol>
<li>Libsodium 算法 来自：<a href="https://github.com/jedisct1/libsodium">https://github.com/jedisct1/libsodium</a></li>
<li>Native代码混淆器：<a href="https://fuzion24.github.io/android/obfuscation/ndk/llvm/o-llvm/2014/07/27/android-obfuscation-o-llvm-ndk">obfuscation-o-llvm-ndk</a></li>
</ol>
<h3>注意 : SO会变大的问题</h3>
<p><img src="https://github.com/weizongwei5/AESJniEncrypt/raw/master/img/unobfscator_debugapk.png" alt="未混淆的so"/>
<img src="https://github.com/weizongwei5/AESJniEncrypt/raw/master/img/obfscator_screen.png" alt="已混淆的so"/></p>
<p>对比： 混淆后的so是混淆前的三倍大小。</p>
<p>如果SO文件大小对您的项目有影响，你可以选择停用SO扰乱的，因为还有其他安全检查。</p>
<h3>补充:</h3>
<p>因为需要做签名校验,所以无法提供jcenter依赖了,望见谅！！</p>
<p>不管代码安全性多高,我依旧反对key存到代码里。</p>
<p>有问题及时提:<a href="https://github.com/weizongwei5/AESJniEncrypt/issues/new">new issues</a></p>
<p>想要编译出混淆过native代码的so需要修改aesjni/build.gradle文件中的externalNativeBuild,并配置NDK下的Obfuscator-LLVM。</p>
<p>这是我的NDK配置混淆器教程：<a href="https://github.com/weizongwei5/Obfuscator-LLVM-4.0-BUILD-NDK">Obfuscator-LLVM-4.0-BUILD-NDK</a>.</p>
<p>如果您觉得配置Obfuscator-LLVM太难,我推荐您使用docker : <a href="https://github.com/nickdiego/docker-ollvm">github.com/nickdiego/docker-ollvm</a>.</p>
<p><a href="https://github.com/weizongwei5/AESJniEncrypt/issues/8">其他语言怎么配合加解密？</a></p>
<p>如果你遇到了崩溃，请看<strong>FigureOutJNICrash.md</strong>，这个是个so崩溃定位的教程。</p>
<hr/>
<h2>合规</h2>
<p>如果你生活在中国，请注意<a href="http://www.miit.gov.cn/n1146295/n7281315/c7507241/part/7507297.docx">工信部整治八项违规</a>.
我调用了PackageManger<a href="https://github.com/BruceWind/AESJniEncrypt/blob/master/aesjni/src/main/cpp/check_emulator.c#L43">检查签名</a>，我只是<strong>读取当前安装的app</strong>, 这可能被认为<strong>收集了安装列表</strong>。从规定上来讲并不违规，只是读取了，并没<strong>收集</strong>，收集是违规的，读取是合规的。
只是目前有可能被误认为<strong>收集</strong>。</p>
<h3>贡献者</h3>
<p><a href="https://github.com/larry19840909">https://github.com/larry19840909</a></p>
<p><a href="https://github.com/zxp0505">https://github.com/zxp0505</a></p>
<p><a href="https://github.com/baoyongzhang">https://github.com/baoyongzhang</a></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"reach-high-security-in-android","title":"Reach high security in Android","mdsource":"https://raw.githubusercontent.com/BruceWind/AESJniEncrypt/master/README_zh.md","date":"2016-11-29","category":"开源"},"content":"[English](https://github.com/BruceWind/AESJniEncrypt/blob/master/README.md)\n\n[中文](https://github.com/BruceWind/AESJniEncrypt/blob/master/README_zh.md)\n\n# 追求极致的代码安全性保障 \n- [x] ~~ndk实现AES加密~~,性能不佳,已废弃此方式, 如果您仍旧需要该算法，check out tag: [v2.2](https://github.com/BruceWind/AESJniEncrypt/releases/tag/v2.2).\n- [x] 使用**CHACHA20**加密,TLS1.3也在移动端用了**CHACHA20**了,性能对ARM架构CPU更好。\n- [x] 使用JniOnload 隐藏C函数\n- [x] 使用签名校验避免被再次打包（这是绕过破解加密算法直接调用你的jni函数）\n- [x] ~~key存在符号表中,同时隐藏字符表~~ 该方案已经废弃,[废弃原因issues5](https://github.com/weizongwei5/AESJniEncrypt/issues/5)\n- [x] 手工处理隐藏key,最复杂的方案：将密钥分成不同的几段,存储在不同的代码中,最后将他们拼接起来,可以将整个操作写的很复杂,增加逆向难度。（目前代码里用的是稍微简单的方案）\n- [x] 使用obfuscator扰乱C的代码,[关于破解obfuscator](https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html)\n- [x]  增加obfucator对x86的支持,具体配置obfucator的教程底部有链接。\n- [x] 反动态调试 , 目前代码里是比较简单的方案, 有更复杂更高明的方案,比如：每次执行加密解密签先去判断是否被trace,想要更复杂的自己fork之后去写\n- [x] 代码运行时屏蔽模拟器 :代码来自我的另外一个仓库[Check_Emulator_In_NDK](https://github.com/Scavenges/Check_Emulator_In_NDK)\n- [ ] TODO：防止so代码被code inject\n\n## 尝试编译，并跑起来\n\u003cdetails\u003e\n\u003csummary\u003eclick to open\u003c/summary\u003e\n1.准备：\n\n运行这个shell :\n\n``` ./build_libsodium_for_all_android_abi.sh ```\n 当你初次运行该脚本, 一些错误你可能会看到: \n```\nenv: python: No such file or directory\n...\nSee \"config.log\" for more details or others.\n```\n这些都是一些基础依赖需要安装到电脑，您可以尝试复制该错误信息，进行Google搜索。\n\n2.打开AS运行app，从adb/AS里看日志。 \n\u003c/details\u003e\n    \n## 集成\n\n\u003cdetails\u003e\n\u003csummary\u003eclick to open\u003c/summary\u003e\na.先配置local.properties中ndk.dir 要求使用ndk版本必须11-13b,新版本ndk没有测试过,或许不能编译通过。\n\nb.集成到项目中请修改类名方法名,不要暴露加密算法,自行修改key存储到代码里的方案.\n\nb.1. 生成 chacha20 key: \n    \nrun `test_in_exexutaing.sh`,然后请看logcat. 我用C语言随机生成的key \u0026 nonce会显示出来. 你需要粘贴到 **JNIEntry.c**.\n\nc.生成和修改签名.\n\n**c.1.生成keystore**\n\n```shell script\n# my generate record:\nmkdir keystore\ncd keystore/\nkeytool -genkey -alias client1 -keypass 123456 -keyalg RSA -keysize 1024 -validity 365 -storetype PKCS12 -keystore ./androidyuan.keystore\n```\n\n**c.2.用java取得当前keystore的hash值,并修改native代码中的包名和hash**\n\n    用[getSignature()](https://github.com/BruceWind/AESJniEncrypt/blob/519a4f16ee0a61b05f8dd41419e3fe61836ee5c7/aesjni/src/main/java/com/androidyuan/aesjni/SignatureTool.java#L26)打log取出之后,然后写入到C文件中,重新build项目。\n    \n  集成到自己项目中请先修改`check_signature.h`中的keystore hashcode和包名。\n  \n\u003c/details\u003e\n\n## 鸣谢\n\n1. Libsodium 算法 来自：https://github.com/jedisct1/libsodium\n2. Native代码混淆器：[obfuscation-o-llvm-ndk](https://fuzion24.github.io/android/obfuscation/ndk/llvm/o-llvm/2014/07/27/android-obfuscation-o-llvm-ndk)\n\n\n\n\n\n### 注意 : SO会变大的问题\n\n![未混淆的so](https://github.com/weizongwei5/AESJniEncrypt/raw/master/img/unobfscator_debugapk.png)\n![已混淆的so](https://github.com/weizongwei5/AESJniEncrypt/raw/master/img/obfscator_screen.png)\n\n对比： 混淆后的so是混淆前的三倍大小。\n\n如果SO文件大小对您的项目有影响，你可以选择停用SO扰乱的，因为还有其他安全检查。\n\n### 补充:\n因为需要做签名校验,所以无法提供jcenter依赖了,望见谅！！\n\n不管代码安全性多高,我依旧反对key存到代码里。\n\n有问题及时提:[new issues](https://github.com/weizongwei5/AESJniEncrypt/issues/new)\n\n想要编译出混淆过native代码的so需要修改aesjni/build.gradle文件中的externalNativeBuild,并配置NDK下的Obfuscator-LLVM。\n\n这是我的NDK配置混淆器教程：[Obfuscator-LLVM-4.0-BUILD-NDK](https://github.com/weizongwei5/Obfuscator-LLVM-4.0-BUILD-NDK).\n\n\n如果您觉得配置Obfuscator-LLVM太难,我推荐您使用docker : [github.com/nickdiego/docker-ollvm](https://github.com/nickdiego/docker-ollvm).\n\n[其他语言怎么配合加解密？](https://github.com/weizongwei5/AESJniEncrypt/issues/8)\n\n如果你遇到了崩溃，请看**FigureOutJNICrash.md**，这个是个so崩溃定位的教程。\n\n-------------------\n\n## 合规\n如果你生活在中国，请注意[工信部整治八项违规](http://www.miit.gov.cn/n1146295/n7281315/c7507241/part/7507297.docx).\n我调用了PackageManger[检查签名](https://github.com/BruceWind/AESJniEncrypt/blob/master/aesjni/src/main/cpp/check_emulator.c#L43)，我只是**读取当前安装的app**, 这可能被认为**收集了安装列表**。从规定上来讲并不违规，只是读取了，并没**收集**，收集是违规的，读取是合规的。\n只是目前有可能被误认为**收集**。\n\n\n### 贡献者\n\n[https://github.com/larry19840909](https://github.com/larry19840909)\n\n[https://github.com/zxp0505](https://github.com/zxp0505)\n\n[https://github.com/baoyongzhang](https://github.com/baoyongzhang)\n","lang":"cn"},"__N_SSG":true},"page":"/[lang]/blog/[slug]","query":{"lang":"cn","slug":"reach-high-security-in-android"},"buildId":"pUDExLTnYM1HHfZLuoalS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>