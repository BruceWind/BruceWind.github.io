title: 为何SSL&TLS如何工作的,为何安全？
date: 2020-01-17 19:18:39

------------------

# SSL/TLS

先跳过如何工作的这个话题，从逆向攻击的角度去理解他的设计。

### SSL工作流程为何安全？
Q:SSL工作流程为何安全？
A:因为他是对称加密传输，所以安全且性能好。

Q:但是，对称加密的`skey`(symmetric key)怎么存，好像你怎么存都不能做到安全？
A:没有存储，建立连接时随机生成，并传给服务端。

Q:那生成好了传输不是会被抓到吗？
A:不会，因为**skey的字符串用非对称加密传输**：server先下发包含`pub key`的证书，browser使用`pub key`加密生成好的skey发给server，server再用私钥解密，因为私钥没有泄漏，所以没人能从中间解密。即使中间人抓到了`pub key`， 但是没有人能拿到对称加密过程的skey。

Q:这样子看上是去比较安全，那**如果中间人替换了证书**？
A：browser会做证书链校验。server给的是一个证书链，需要从根证书开始层层校验。[查看百度配置的证书详细信息，内含证书链](https://myssl.com/www.baidu.com?domain=www.baidu.com&port=443)

baidu.com证书链如下:
```mermaid
graph LR
A(GlobalSign Root CA) -- verify --> B(GlobalSign Organization Validation CA)
B -- verify --> C(baidu.com)
```

Q:证书链校验过程是什么？
> - A:跳过**过期**，**被吊销**的检查，只谈通过算法验证证书真实性：
> - - 证书文件生成时会**追加**一个数字签名，你可以搜一下生成证书的流程，都是需要签名的。这个用于生成签名`私钥`来自上机证书。既然验证时需要向上追溯，肯定不能无限追溯，总要有个底，对的，的确有个根证书。验证证书链时，就是从根证书一级级地上向校验,根证书存在于浏览器或者操作系统中了。

Q:怎么校验单个证书的签名？
A:签名生成过程：`原文--原文的哈希--私钥加密---签名`，
校验签名过程:`签名---公钥解密得到哈希----对原文进行哈希--比对两个哈希`。哈希值相同，则证明明文的发送者，是私钥的持有者。这个模式的设计要归功与`非对称加密算法`的发明。

Q: 那根证书如何信任？听上去感觉这个是整个验证的前提。
A:对，这个是一切验证的前提。这个是必须要信任的东西，在系统，或者浏览器被安装时已经存在了，**你只能相信系统**。


如上，看了这么多攻击角度的理解，你看下面，从头理一下他的流程。

### SSL/TLS如何工作？
举例HTTPS工作流程里的SSL示例：
> - 1.你的browser发起请求，从server要一个证书。
> - 2.server给你一个证书，它包含很多信息，其中有public key，他也会告诉你上机证书是谁，可以得到一个证书链。
> - 3.browser会从根证书一层层校验，确认证书不是伪造的。
> - 4.不是伪造之后，browser生成一个用于对称加密的skey，用于后面的传输过程的`对称加密`，所以server也需要知道这个skey，就拿刚刚信赖的证书的`pub key`加密skey，传给server，server用`pri key`解开这个数据，取得skey。
> - 5.前面一步，两边已经都得到一个共用的skey了，之后数据传输就都是用skey对数据做对称加密即可，对称加密的概念不再赘述。


### SSH呢？
大体上跟https这个证书类似，大体的逻辑还是先校验对方身份，然后生成skey，再用非对称加密传递`skey`，另外一方用非对称加密解开skey，后面通信就会用`skey`做对称加解密，至于为什么用对称加密，因为对称加密性能好嘛。第一步`校验`很重要，防止中间人欺骗你。
再说其他细节就还有ssh协议标准是否一致的校验。

自己有服务器的同学都知道，SSH有两种登录方式，第一种是账户密码，这个叫做**口令登录**，第二种是**密钥登录**。
1.口令登录，SSH程序无法确保该服务器是否是个假的，是否为中间人，他会提供一个指纹给你，让你确认对方是否可信，可信之后后面就不再赘述了，跟上面类似。
这里你肯定要问，我如何确认我的服务器指纹?其实你创建一个服务器时，会生成好一套key，如果你买的虚拟服务器，可能从panel那边查到指纹，或者提供给你的webshell里手动查询一下。实际上，特么大多数管理员不提供主机密钥指纹。

2.密钥登录，是你把你的pub key 丢给server。利用非对称加密的安全性，这个其实比你用口令登录更安全。


### android的keystore签名呢？


### 如果你做一个点对点通信的加密程序呢？


### 主流的安全设计