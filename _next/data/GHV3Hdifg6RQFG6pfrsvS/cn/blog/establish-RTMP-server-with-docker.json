{"pageProps":{"post":{"slug":"establish-RTMP-server-with-docker","title":"用docker在当前电脑起一个RTMP推流服务器","mdsource":"md/establish-RTMP-server-with-docker.md","date":" 2021/05/02 22:38:08","category":"几年后回看会觉得写的太烂"},"content":"title: 用docker在当前电脑起一个RTMP推流服务器\ndate: 2021/05/01 01:24:01\nupdated: 2021/05/01 22:52:11\ncategories:\n- 技术\n---\n\nIn the past, I used to [establish a RTMP stream server](https://www.cameraremote.de/how-to-setup-a-rtmp-streaming-server-on-raspberry-pi-e-g-for-gopro-cameras/) on a Raspbery PI.\n\nObviously Raspberry PI is small in your workbench，but you still need to give it little space and a electric charge.\nMay the action disturbs your working. \n\nAnd now using docker is easy to establish RTMP server.\n\n> There are several docker images to establish it on docker:\n\n## nginx-rtmp image\n\n**docker pull & run it.**\n\n``` shell script\ndocker pull tiangolo/nginx-rtmp\ndocker run -d -p 80:80 -p 1935:1935 --name nginx-hls tiangolo/nginx-rtmp # bind ports : {1935, 80}\n```\n\n**The push stream url:** \n\n`rtmp://{ip}/live/{id}`\n\n> change {id} if you want，it is stream id.\n\n**The play url:** \n\n`rtmp://{ip}/live/{id}`\n\nIt is over in the event that you don't want play a HLS url.\n\nBefore pushing stream to your docker container via these urls,  you can try to use [obs]\n(https://obsproject.com/) to test urls in advance.\n\n## nginx-hls \n\n> It has HLS live stream (and has transcoding)\n\nIn case you wanting HLS live url, modify  conf: `vi /etc/nginx/nginx.conf` :\n\nBefore run it, execute: `docker exec -it nginx-hls bash` to enter docker system.\n\n``` \nworker_processes  auto;\nevents {\n    worker_connections  1024;\n}\n\n# RTMP configuration\nrtmp {\n    server {\n        listen 1935; # Listen on standard RTMP port\n        chunk_size 4000;\n\n        application show {\n            live on;\n            # Turn on HLS\n            hls on;\n            hls_path /mnt/hls/;\n            hls_fragment 3;\n            hls_playlist_length 60;\n            # disable consuming the stream from nginx as rtmp\n            deny play all;\n    # Instruct clients to adjust resolution according to bandwidth\n            hls_variant _low BANDWIDTH=512000; # Low bitrate, sub-SD resolution\n            hls_variant _mid BANDWIDTH=1024000; # Medium bitrate, SD resolution\n            hls_variant _hd720 BANDWIDTH=2048000; # High bitrate, HD 720p resolution\n        }\n\n    }\n}\n\nhttp {\n    sendfile off;\n    tcp_nopush on;\n    #aio on;\n    directio 512;\n    default_type application/octet-stream;\n\n    server {\n        listen 80;\n\n        location / {\n            # Disable cache\n            add_header 'Cache-Control' 'no-cache';\n\n            # CORS setup\n            add_header 'Access-Control-Allow-Origin' '*' always;\n            add_header 'Access-Control-Expose-Headers' 'Content-Length';\n\n            # allow CORS preflight requests\n            if ($request_method = 'OPTIONS') {\n                add_header 'Access-Control-Allow-Origin' '*';\n                add_header 'Access-Control-Max-Age' 1728000;\n                add_header 'Content-Type' 'text/plain charset=UTF-8';\n                add_header 'Content-Length' 0;\n                return 204;\n            }\n\n            types {\n                application/dash+xml mpd;\n                application/vnd.apple.mpegurl m3u8;\n                video/mp2t ts;\n            }\n\n\n            root /mnt/;\n        }\n\n}\n}\n\n```\n\n\n** The url you can push stream into：**\n\nWith transcoding：\n`rtmp://localhost/show/live_hd720` , you can replace ***live_{low|mid|hd720}***\n\nNo transcoding：`rtmp://localhost/show/live`\n\n**the HLS url you try to play：**\n\n`http://localhost/hls/live.m3u8`\n\n\n## [ossrs/srs](https://github.com/ossrs/srs)\n\n> If you want all of play protocols, this docker image is first recommendation.\n\n\n```\ndocker pull ossrs/srs:3\ndocker run --rm -p 1935:1935 -p 1985:1985 -p 8080:8080 ossrs/srs:3\n```\n\n**push url:**\n\n`rtmp://localhost/live/live`\n\n**play url:**\n\n`rtmp://localhost/live/live`;\n\n`http://localhost:8080/live/live.flv`;\n\n`http://localhost:8080/live/live.m3u8`.\n\nIn addition, **ossrs/srs** may not be very perfect, so I put it to end of the blog.\n","lang":"cn"},"__N_SSG":true}