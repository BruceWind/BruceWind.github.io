{"pageProps":{"post":{"slug":"%E8%A7%A3%E5%86%B3gradle%E4%B8%8B%E8%BD%BD%E6%85%A2%E5%92%8C%E7%BC%96%E8%AF%91%E6%85%A2","title":"解决gradle下载慢和编译慢.md","mdsource":"md/解决gradle下载慢和编译慢.md","date":" 2016/03/05 23:37:38","category":"几年后回看会觉得写的太烂"},"content":"title: 解决gradle下载慢和编译慢\ndate: 2016/03/05 23:37:38\nupdated: 2016/03/06 09:13:18\ncategories:\n- 技术\n---\n由于各种不可描述的原因境内下载很慢。\n本文是围绕gradle目录的gradle-xxxx-all.zip下载慢，和依赖的aar,jar下载慢这两块。linux或mac环境，windows用户不用看下去了。\n\n# 一：解决下载缓慢\n-------\n\n## 1.直接代理\n\n> + 合格大陆程序员一定要有代理，没有代理的二流程序员请跳过这部分：\n\n### 1.a.命令行下所有的http(s)请求加代理（不止gradle命令）\n推荐使用别名加如到**~/.bashrc**最后一行，这样子当你需要下载各种东西的时候用别名代替输入这行字符串非常方便。\n```\nalias proxyterminal='export http_proxy=http://127.0.0.1:1080;export https_proxy=http://127.0.0.1:1080;'\n```\n### 1.b.给gradle命令编译配置独立的http代理：\n编辑**~/.gradle/gradle.properties**:\n\n```\n//cat ~/.gradle/gradle.properties\nsystemProp.http.proxyHost=127.0.0.1\nsystemProp.http.proxyPort=1080\n\nsystemProp.https.proxyPort=1080\nsystemProp.https.proxyHost=127.0.0.1\n\nsystemProp.http.nonProxyHosts=*.cn|localhost|*.aliyun.com|172.*|10.23*|192.168*|*.cn\nsystemProp.https.nonProxyHosts=*.cn|localhost|*.aliyun.com|172.*|10.23*|192.168*|*.cn\n```\n你项目根目录的配置文件**gradle.properties**也可以拷贝这个进行配置。\n\n\n如果您有代理，那就没必要再往下看了。**全剧终止！**\n\n## 2.下载gradle-xxxx-all.zip(无代理)：\n\n### 2.a.使用官方cdn节点下载\n\n~~https://services.gradle.org/distributions/gradle-6.6-all.zip~~\n\nhttps://downloads.gradle-dn.com/distributions/gradle-6.6-all.zip\n\n\n### 2.b.手动下载放置目录（使用其他下载器）\n下载好丢到~/.gradle/wrapper/dists这个目录里，再重启as，或者命令行重新编译。\n\n# \n\n### 2.c.下载zip传到git上去\n你保存到当前project根目录,/project/gradle/wrapper/下,\n并且修改**gradle-wrapper.properties**文件。\n```distributionUrl=gradle-2.2.1-all.zip```\n之后就可以在idea或者as中rebuild一下即可。这里就可以跳过下载gradle的过程，继续下载依赖的jcenter代码库了。\n这时候直接`git lfs track \"*.zip\" & git add /project/gradle/wrapper/gradle-2.2.1-all.zip`,然后把这个推到你们的git服务器上去。\n**git lfs**是large file服务，不懂请联系运维。\n\n## 3.解决依赖的aar,jar下载慢(无代理)\n\n### 3.a 走国内镜像：\n\n```\n//该方案不能解决所有依赖，可能当前仓库部分的依赖是aliyun里没有的。\nallProjects {\n    repositories {\n\t\tmaven { url 'https://maven.aliyun.com/repository/public/' }\n        maven { url 'https://maven.aliyun.com/repository/google/'}\n        maven { url 'https://maven.aliyun.com/repository/jcenter/'}\n\n        mavenLocal()\n        mavenCentral()\n    }\n}\n//这里没有google的镜像，主要google在我这边测试速度还挺快，应该他们自己弄了国内的节点。\n```\n\n## 3.a 自建nexus镜像\n\n找公司申请一台台式机，弄个局域网的nexus镜像服务器。\n\n\n# 二.gradle开启multidex之后构建缓慢问题\n-------\n\n项目越来越大，导入各种第三方的包，导致项目java方法数很轻松超过64K，那么gradle构建就会轻易的进入到一种很蛋疼的境地，直接报错  `/user/jdk/bin/.....  exit 2.`\n那么解决方案只有一个就是 开启mutidex，multidex就会带来构建缓慢的问题。\n就算我们开发本机有jcenter，maven库和gradle缓存，依旧是构建很慢。\n# \n找到的一些解决构建速度问题的方法。如下：\n\n## 1.可以考虑增加 studio.vmoptions 中内存设置\n\n使用idea或者as开发,可以到编译器所在的主目录下搜索*.vmoptions 文件,可能会搜索到两个文件.  一个32位的一个6x64的，打开那个文件修改'-Xmx....'，  这个是最大申请内存限制的配置，配置之后，重启下 IDE。\n\n## 2. 使用最新版本gradle\n\n\n## ３.请更改minsdkversion 版本 和ssd\n首先必须保证 SSD 和通畅的网络环境；\nssd主要是解决构建大量的IO的问题。\n\n其次可以考虑增加 studio.vmoptions 中内存设置；\n如果是大项目 (multidex) 编译慢我知道一招，Gradle 中添加\n```\n    defaultConfig {\n        ......\n        if (gradle.startParameter.taskNames.contains(\":app:assembleDebug\")) {\n            minSdkVersion 21\n        }else{\n            minSdkVersion 18\n        }\n    }\n```\nminSdkVersion 设置为 Android API 级别 21 的调试应用。这些设置会使 Android Gradle 插件执行以下操作：\n\n> + 每个子模块构建为单独的dex文件。不再做合并操作。因此可以避免为确定主 dex 文件的内容而进行长时间的计算。\n> + 将每个 dex 文件加入 APK 时不做任何修改。\n\n不过这个方案的弊端就是：\n如果开发机 SDKVersion 没到 21 就跑不起来了；\n如果用不到 multidex 还觉得编译慢请升级机器；\n# \n用了这个之后，就在18s左右了。已经跟ios编译速度相等了。\n这个方案后来还是没有使用，在全民TV，公司给研发同学的机器依旧有一半是低于5.0的设备，没办法，部分研发调试都无法用了，很蛋疼。不使用这个功能，其他的都配置了，编译速度从2分钟降到50s左右了，总之不是很理想。\n\n\n## 4.加大javaheap内存限制  （要求开发的电脑内存要大于4G）\n```\n    dexOptions {//解决构建缓慢问题\n        javaMaxHeapSize \"4g\" //当然可以更大 \n    }\n```\n\n## 5.修改默认配置 (改善命令行编译)\n在gradle 目录下“创建 `gradle.properties`文件，gradle目录在\n`\n~/.gradle/ (Linux)\n~/.gradle/ (Mac)\nC:\\Users\\<username>\\.gradle (Windows)\n`\n文件内写：\n`\norg.gradle.daemon=true //进程守护\norg.gradle.parallel=true\n`\n\n## 6.使用官方gradle提供的分析工具\n官方耗时分析工具,可以帮忙分析耗时的位置,\n```\n./gradlew --profile --recompile-scripts --offline --rerun-tasks assembleDebug\n//只分析debug模式下的情况.\n```\n\n```\n导出的HTMl的部分内容:\nProfile report\nProfiled build: assembleDebug\n\nStarted on: 2017/03/23 - 12:35:47\n\nSummary\nConfiguration\nDependency Resolution\nTask Execution\nDescription\tDuration\nTotal Build Time\t1m18.44s\nStartup\t1.361s\nSettings and BuildSrc\t0.496s\nLoading Projects\t0.205s\nConfiguring Projects\t5.912s\nTask Execution\t2m29.34s\n```\n\n## 7.修改gradle所在虚拟机的xmx参数\n\ngradle-wrapper.properties\n```  \n> 修改gradle所在JVM的xmx参数,但是生效需要 重启 gradle\norg.gradle.jvmargs = -Xmx2048m\n```\n\n一些较大的项目可能会受益于更大的Gradle堆大小。但是，如果使用低内存计算机，则可能需要将IDE配置为使用更少的内存。要了解如何更改分配给IDE和Gradle的资源数量会影响构建性能，请转到关于概要分析构建的部分。\n\n注意：如果Gradle守护程序已经运行，则需要在使用新设置进行初始化之前停止该进程。您可以通过选择View> Tool Windows> Terminal终止并输入以下命令来终止Gradle守护程序：gradlew --stop。\n\n## 8.忽略配置直接命令行编译\n```\n./gradlew assembleDebug  -x lint  --parallel --max-workers=6   -PminSdk=21\n```\n\n公司给我配的是高配Thinkpad, 固态盘，i7处理器，8G ram。之前是1分50秒降到50秒以内的构建速度。更改如上这些东西之后，是50秒以内。同事的mac laptop要比我的linux还快几秒。\n\n\n# 三.解决由开启了multidex带来的app性能下降的问题\n-------\n前面说了一些编译器的问题解决，但是终究apk的性能问题还是丢在这里没人过问\n使用TurboDex\n\n    摘录自turbodex\n众所周知,Android中在Runtime加载一个 未优化的Dex文件 (尤其在 ART 模式)需要花费 很长的时间. 当你在App中使用 MultiDex 或 插件化框架 的时候, 这个问题就会显得十分严重.\n\nTurboDex 就是为了解决这一问题而生, 就像是给AndroidVM开启了上帝模式, 在引入TurboDex后, 无论你加载了多大的Dex文件,都可以在毫秒级别内完成.\n\n    TurboDex 的使用始终是好的，就算你的项目构建没有开启multidex也是可以使用的。\n\n\n","lang":"cn"},"__N_SSG":true}