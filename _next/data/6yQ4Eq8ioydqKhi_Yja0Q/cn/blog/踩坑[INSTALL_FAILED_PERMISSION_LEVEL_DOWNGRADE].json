{"pageProps":{"post":{"slug":"踩坑[INSTALL_FAILED_PERMISSION_LEVEL_DOWNGRADE]","title":"踩坑[INSTALL_FAILED_PERMISSION_LEVEL_DOWNGRADE].md","mdsource":"md/踩坑[INSTALL_FAILED_PERMISSION_LEVEL_DOWNGRADE].md","date":" 2016/06/19 01:22:36","category":"几年后回看会觉得写的太烂"},"content":"title: 踩坑[INSTALL_FAILED_PERMISSION_LEVEL_DOWNGRADE]\ndate: 2016/06/19 01:22:36\nupdated: 2016/07/14 22:50:47\ncategories:\n- 技术\n---\n情况是这样子的：\n产品反馈：从1.4版本升级到2.0,发现提示**应用未安装**。我去什么鬼！！！\n当时上线时都测试了，怎么会出现呢！擦擦擦！\n# \n## 按照以往的经验：\n1.常见都是签名问题。\n2.文件下载不完整，这种情况有的手机会显示**未安装**,有的手机显示出**解析包错误**。\n\n# \n## 这个问题是怎么找到根源的 \n其实当时确实怀疑了签名问题，so，找个apk读取签名的工具，以前用过一个叫做`Gen_signature_Android.apk`微信支付官方就有读取某个安装的应用的apk的签名文件MD5，[链接在此点我跳转](https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419319167&token=&lang=zh_CN)\n分别安装了两个版本，用Gen_signature工具读取每个版本的签名的md5,发现都是相同的。没什么卵用。不是签名问题。\n\n# \n后来详细的测试，发现只有6.0的机器会发生这个情况。怪不得当时没有测试出来。\n# \n## 命令安装,如果发生失败起码会给我显示失败原因\n\n想到命令安装,如果失败起码会给我失败的原因。这会是一个好的突破点。\n\n就用360手机助手导出了手机安装的apk包，当然我没有windows 没有手机助手，好想命令也可以导出apk，但是时间不多来不及解释了。导出之后再下载一个最新版。\n\n先用命令尝试安装老的包\n```\nadb install xxx.apk\n//轻松安装成功\n```\n然后安装新版本的。\n```\nadb install -r  xxx.apk\n//打印如下\nFaild [INSTALL_FAILED_PERMISSION_LEVEL_DOWNGRADE]\n```\n**DOWNGRADE**这个单词比较特别，压根就没见过。\n我擦，\n\ndict 命令翻译了一下：\n```\nweideAir:~ wei$ dict DOWNGRADE\n###################################\n#  downgrade 降级 (U: ,daʊn'ɡred E: 'daʊngreɪd; daʊn'greɪd )\n#  n. 退步；下坡\n#  adj. 下坡的\n#  vt. 使降级（过去式downgraded，过去分词downgraded，现在分词downgrading，第三人称单数downgrades）；小看\n#  adv. 下坡地\n###################################\n```\n是降级的意思。我擦，竟然是这样子的。\n查了下网上给的方案都是versioncode，仔细对比versioncode是没问题的草草草！！\n\n公司的一位领导坐我旁边说这个“可能是跟权限有关”。\n那么唯一有关的就只是targetversion，targetversion会影响app在制定版本的api的手机上的运行的效果这个倒是真的，之前就读过国内一些博客所说的targetversion的概念。\n\n#\n于是用aapt命令读取两个apk包的targetversion分别是多少。\n\n```\naapt dump baging ***.apk\n```\n1.4版本是`23`，2.0是`19`。那很可能是这里的问题。\n# \n重新打包测试了下,确定了是这个问题，只要修改targetversion为23之后，就可以覆盖1。4版本安装，不再报错了。\n\n# \n只是一开始不去怀疑这点，确实是因为之前的一些项目修改这个，确实都没有发生过什么问题。现在在6.0上开始不让修改了这个消息还真不知道。\n\n## 深沉的检讨\n    4.1当时项目发一个版本发版时更改了targetversion，必须得承认这是我的错误。毋庸置疑！ 我的锅！\n\n## 深深的甩锅给谷歌\n以前也经常改这个字段，从没发生过问题。5.0降级还没有任何问题呢！官方总要给点提示吧！而且直接guge搜DOWNGRADE错误给出的答案都是versioncode。 难道因为我这里是china？？\n我这里就信息封闭！！！\n于是去android devrloper官方：\nhttps://developer.android.com/guide/topics/manifest/uses-sdk-element.html\n文章给了一堆的targetversion的原理的介绍。并没有写出android 6.0之后这个targetversion就不能再降级了。\n我擦！！！大爷的！！！你妹啊！你可是官方啊！！！官方都不给这个坑的提示。。。你们不要拦着我，我要转IOS开发！！！\n\n欣慰的是这个错误导致的人数并不多，当时发版本的时候市面上android 6.0的机器并不多。很难买到6.0的机器。华为算是国内最早的发布6.0 的机器的厂商了，他们发布的时候也都到了16年年初了。\n\n# 业内到底有多少人不知道这个坑？\n我平时也有订阅一些android方面的周报的习惯，一些新的技术，比如android 6.0的运行时权限很早也有关注，也写过demo。但是这个坑实在是没有发现有人写过，所以这篇博客po出来的目的就是在此，希望后人不要踩坑。\n\n![](assets/downgrade3.png)\n\n![](assets/downgrade4.png)\n\n![](assets/downgrade1.png)\n\n![](assets/downgrade2.png)\n# 如上：截图时搜索并没有筛选时间，截图过了才想起来需要过滤筛选一下时间为一年内的，但是实际上筛选了一样没有搜到有说6.0手机targetversion不能降级的。\n----------------\n### 似乎目前没有任何博客和文章说过android 6.0不能随意的更改targetversion，那我发现了就贡献出来，这就是这片文章出现在你面前的原因。\n\n\n\n","lang":"cn"},"__N_SSG":true}